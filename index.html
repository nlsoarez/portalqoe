<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Portal de Análise de Incidentes</title>

  <!-- CSS & Libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/vfs_fonts.js"></script>

  <style>
    :root {
      --claro-red:#e30613; --claro-green:#29a329; --claro-yellow:#e3a81e;
      --claro-blue:#0066cc; --bg-soft:#f7f7f7;
    }
    body{background:var(--bg-soft);}
    .app-header{background:#1a1a1a;color:#fff;}
    .brand-dot{width:.75rem;height:.75rem;border-radius:50%;background:var(--claro-red);display:inline-block;margin-right:.5rem;}
    .sidebar{min-height:100vh;background:#fff;border-right:1px solid #e9ecef;}
    .sidebar .nav-link.active{background:var(--claro-red);color:#fff;}
    .upload-drop{border:2px dashed var(--claro-blue);border-radius:.75rem;padding:1.25rem;text-align:center;background:#fff;}
    .upload-drop.dragover{background:#eef6ff;border-color:var(--claro-red);}
    .legend-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:.35rem;}
    .chart-wrap{position:relative;height:340px;}
    .text-danger{color:#e30613!important;}
    .text-warning{color:#e3a81e!important;}
    .text-success{color:#29a329!important;}
    .fw-bold{font-weight:700!important;}
    .pointer{cursor:pointer;}
    .details-row td{border-top:none;font-size:.9rem;}
    .details-row ul li{padding:3px 0;border-bottom:1px solid #eee;}
  </style>
</head>
<body>
<header class="app-header py-3">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    <h1 class="h4 m-0"><span class="brand-dot"></span>Portal de Análise de Incidentes</h1>
    <div class="d-flex gap-2">
      <input id="inputFile" type="file" class="form-control form-control-sm" accept=".xlsx,.xls,.csv"/>
      <button id="btnDemo" class="btn btn-outline-light btn-sm"><i class="bi bi-magic"></i> Demo</button>
    </div>
  </div>
</header>

<div class="container-fluid">
  <div class="row">
    <!-- ===== SIDEBAR ===== -->
    <nav class="col-12 col-md-3 col-lg-2 sidebar p-3">
      <div class="upload-drop mb-4" id="dropArea">
        <i class="bi bi-cloud-arrow-up fs-2 text-primary"></i>
        <p class="mb-1">Arraste e solte sua planilha aqui</p>
        <span class="small-note">Ou clique no campo acima</span>
      </div>

      <!-- Filtros -->
      <h6 class="text-uppercase text-muted mb-2">Filtros</h6>
      <div class="mb-2">
        <label class="form-label">Cluster</label>
        <select id="filtroCluster" class="form-select form-select-sm">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label">Cidade</label>
        <select id="filtroCidade" class="form-select form-select-sm">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label">Período</label>
        <div class="d-flex gap-1">
          <input id="filtroDataIni" type="date" class="form-control form-control-sm"/>
          <input id="filtroDataFim" type="date" class="form-control form-control-sm"/>
        </div>
      </div>
      <div class="d-grid gap-2 mt-2">
        <button class="btn btn-primary btn-sm" id="btnAplicarFiltros"><i class="bi bi-funnel"></i> Aplicar</button>
        <button class="btn btn-outline-secondary btn-sm" id="btnLimparFiltros"><i class="bi bi-x-circle"></i> Limpar</button>
      </div>

      <hr class="my-4"/>
      <div class="nav flex-column gap-1" role="tablist">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCluster" type="button"><i class="bi bi-diagram-3"></i> Incidentes por Cluster</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabQOE" type="button"><i class="bi bi-arrow-left-right"></i> QOE Pré vs Pós</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFechamento" type="button"><i class="bi bi-pie-chart"></i> Tipo de Fechamento</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabReinc" type="button"><i class="bi bi-clock-history"></i> Reincidência</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabResumo" type="button"><i class="bi bi-speedometer2"></i> Dashboard</button>
      </div>
    </nav>

    <!-- ===== MAIN ===== -->
    <main class="col-12 col-md-9 col-lg-10 p-3 p-md-4">
      <div class="tab-content">
        <!-- INCIDENTES -->
        <section class="tab-pane fade show active" id="tabCluster">
          <h5>Incidentes por Cluster</h5>
          <div class="row">
            <div class="col-12 col-lg-5">
              <table class="table table-sm" id="tblCluster">
                <thead><tr><th>Cluster</th><th class="text-end">Incidentes</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="col-12 col-lg-7"><div class="chart-wrap"><canvas id="chartCluster"></canvas></div></div>
          </div>
        </section>

        <!-- QOE -->
        <section class="tab-pane fade" id="tabQOE">
          <h5>QOE Pré vs Pós</h5>
          <table class="table table-sm" id="tblQoeNode">
            <thead><tr>
              <th>Node</th><th>Cluster</th><th>Cidade</th>
              <th class="text-end"><strong>Pré</strong></th>
              <th class="text-end"><strong>Pós</strong></th>
              <th class="text-end">Variação</th><th>Status</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- FECHAMENTO -->
        <section class="tab-pane fade" id="tabFechamento">
          <h5>Tipo de Fechamento</h5>
          <div class="row">
            <div class="col-12 col-lg-6"><div class="chart-wrap"><canvas id="chartFechamento"></canvas></div></div>
            <div class="col-12 col-lg-6">
              <table class="table table-sm" id="tblFechamento">
                <thead><tr><th>Tipo</th><th class="text-end">Volume</th><th class="text-end">%</th></tr></thead>
                <tbody></tbody>
              </table>
              <div id="legendFechamento" class="mt-2"></div>
            </div>
          </div>
        </section>

        <!-- REINCIDÊNCIA -->
        <section class="tab-pane fade" id="tabReinc">
          <h5>Log de Reincidência</h5>
          <table class="table table-sm" id="tblReinc">
            <thead><tr><th>Node</th><th>Cluster</th><th>Cidade</th><th class="text-center">Ocorrências</th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <!-- DASHBOARD -->
        <section class="tab-pane fade" id="tabResumo">
          <h5>Dashboard Resumo</h5>
          <div id="cardsResumo" class="row g-3"></div>
        </section>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const $=(s,c=document)=>c.querySelector(s);
let DATA_ALL=[], RAW=[], charts={};

const AUTO_MAP={'INCIDENTE':'Tipo_Incidente','CIDADE':'Cidade','CLUSTER':'Cluster','HI (DATA E HORA INÍCIO)':'Data','NODE':'Node','RET':'RET','QOE PRÉ':'QOE_Pre','QOE PÓS':'QOE_Pos','SOLUÇÃO':'Tipo_Fechamento','HF (DATA E HORA FIM)':'Data_Fim','OBSERVAÇÃO':'Observacao','OUTAGE DE MDU VINCULADO':'Outage_MDU'};

function safeVarPct(qpre,qpos){
  if(!isFinite(qpre)||qpre<=0) return 0;
  return ((qpos - qpre)/qpre)*100;
}

function fmtPct(n){
  if(!isFinite(n) || Math.abs(n)>1000) return '—';
  return `${n.toFixed(1)}%`;
}

function handleFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    const data=new Uint8Array(e.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    let json=XLSX.utils.sheet_to_json(ws,{defval:'',header:1});
    const header=json[0].map(h=>String(h).trim());
    const mappedHeader=header.map(h=>AUTO_MAP[h.toUpperCase()]||h);
    const rows=json.slice(1).map(r=>{
      const o={};mappedHeader.forEach((h,i)=>o[h]=r[i]);
      if(o['Data']) o['Data']=new Date(o['Data']);
      o['QOE_Pre']=Number(o['QOE_Pre'])||0;
      o['QOE_Pos']=Number(o['QOE_Pos'])||0;
      return o;
    });
    DATA_ALL=rows;RAW=[...rows];
    preencherFiltros();renderAll();
    alert(`✅ ${rows.length} incidentes carregados`);
  };
  reader.readAsArrayBuffer(file);
}

function colorByValue(v){
  if(!isFinite(v)) return '';
  if(v<=40) return 'text-danger fw-bold';
  if(v<=80) return 'text-warning fw-bold';
  return 'text-success fw-bold';
}

function aggregateQoe(rows,keys){
  const map=new Map();
  rows.forEach(r=>{
    const k=keys.map(k=>r[k]||'').join('||');
    const acc=map.get(k)||{cnt:0,qpre:0,qpos:0,Node:r.Node||'',Cluster:r.Cluster||'',Cidade:r.Cidade||''};
    acc.cnt++;acc.qpre+=r.QOE_Pre||0;acc.qpos+=r.QOE_Pos||0;
    map.set(k,acc);
  });
  return Array.from(map.values()).map(v=>{
    const pre=v.cnt?v.qpre/v.cnt:0;
    const pos=v.cnt?v.qpos/v.cnt:0;
    return {...v,qoePre:pre,qoePos:pos,varPct:safeVarPct(pre,pos)};
  });
}

// renderResumo corrigido
function renderResumo(){
  const byCluster=groupBy(RAW,'Cluster');
  const wrap=$('#cardsResumo');
  wrap.innerHTML='';
  Object.entries(byCluster).forEach(([cl,rows])=>{
    const total=rows.length;
    const nodes=groupBy(rows,'Node');
    const reinc=Object.values(nodes).filter(a=>a.length>1).length;
    const taxa=total?(reinc/Object.keys(nodes).length*100):0;
    const varPct=aggregateQoe(rows,['Cluster'])[0]?.varPct||0;
    const qClass=varPct>0?'text-success fw-bold':'text-danger fw-bold';
    const rClass=taxa>20?'text-danger':'text-success';
    const card=document.createElement('div');
    card.className='col-12 col-md-6 col-lg-4';
    card.innerHTML=`<div class="card h-100 shadow-sm border-0"><div class="card-body"><h5>${cl||'(vazio)'}</h5><p><strong>${total}</strong> incidentes</p><p>Δ QOE: <span class="${qClass}">${fmtPct(varPct)}</span></p><p>Taxa Reinc.: <span class="${rClass}">${fmtPct(taxa)}</span></p></div></div>`;
    wrap.appendChild(card);
  });
}

function groupBy(a,k){return a.reduce((acc,c)=>{const key=c[k]||'';(acc[key]||(acc[key]=[])).push(c);return acc;},{});}
</script>
</body>
</html>
