<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Consulta de Ganhos e Perdas</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        input, button { padding: 8px; margin-top: 10px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h2>Consulta de Ganhos e Perdas por Dia</h2>
    <input type="file" id="upload" accept=".xlsx">
    <br>
    <input type="text" id="login" placeholder="Digite o login">
    <button onclick="consultar()">Consultar</button>

    <div id="resultado">
        <table id="tabela">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>% Ganhos</th>
                    <th>% Perdas</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let dadosPlanilha = [];

        document.getElementById('upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets["Data"];
                dadosPlanilha = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                alert("Planilha carregada com sucesso!");
            };
            reader.readAsArrayBuffer(file);
        });

        function consultar() {
            const login = document.getElementById('login').value.trim().toLowerCase();
            if (!login || dadosPlanilha.length === 0) {
                alert("Digite o login e carregue a planilha!");
                return;
            }

            const registros = [];

            for (let i = 1; i < dadosPlanilha.length; i++) {
                const row = dadosPlanilha[i];
                const outage = String(row[0] || "");
                const usuario = String(row[1] || "").toLowerCase();
                const dataRaw = row[2];
                const hfcVol = row[5];
                const hfcInd = row[6];
                const gponVol = row[7];
                const gponInd = row[8];

                if (!usuario.includes(login)) continue;
                if (outage.startsWith("0")) continue;
                if (!dataRaw || isNaN(Date.parse(dataRaw))) continue;

                const data = new Date(dataRaw);
                const dia = data.toLocaleDateString("pt-BR");

                let status = "Ignorado";
                if (hfcVol == 1 && hfcInd == 1) status = "Ganho";
                else if (hfcVol == 1 && hfcInd == 0) status = "Perda";
                else if (gponVol == 1 && gponInd == 1) status = "Ganho";
                else if (gponVol == 1 && gponInd == 0) status = "Perda";

                if (status !== "Ignorado") registros.push({ dia, status });
            }

            const resumo = {};
            registros.forEach(({ dia, status }) => {
                if (!resumo[dia]) resumo[dia] = { total: 0, ganhos: 0, perdas: 0 };
                resumo[dia].total++;
                if (status === "Ganho") resumo[dia].ganhos++;
                if (status === "Perda") resumo[dia].perdas++;
            });

            const corpoTabela = document.querySelector("#tabela tbody");
            corpoTabela.innerHTML = "";

            Object.keys(resumo).sort().forEach(dia => {
                const { total, ganhos, perdas } = resumo[dia];
                const pctGanho = ((ganhos / total) * 100).toFixed(2);
                const pctPerda = ((perdas / total) * 100).toFixed(2);

                const linha = document.createElement("tr");
                linha.innerHTML = `<td>${dia}</td><td>${pctGanho}%</td><td>${pctPerda}%</td>`;
                corpoTabela.appendChild(linha);
            });
        }
    </script>
</body>
</html>
