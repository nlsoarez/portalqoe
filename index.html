<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Portal de Análise de Incidentes</title>

  <!-- CSS & Libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/vfs_fonts.js"></script>

  <style>
    :root {
      --claro-red:#e30613; --claro-green:#29a329; --claro-yellow:#e3a81e;
      --claro-blue:#0066cc; --bg-soft:#f7f7f7; --dark:#1a1a1a;
    }
    body{background:var(--bg-soft);}
    .app-header{background:var(--dark);color:#fff;}
    .brand-dot{width:.75rem;height:.75rem;border-radius:50%;background:var(--claro-red);display:inline-block;margin-right:.5rem;}
    .sidebar{min-height:100vh;background:#fff;border-right:1px solid #e9ecef;}
    .sidebar .nav-link.active{background:var(--claro-red);color:#fff;}
    .upload-drop{border:2px dashed var(--claro-blue);border-radius:.75rem;padding:1.25rem;text-align:center;background:#fff;}
    .upload-drop.dragover{background:#eef6ff;border-color:var(--claro-red);}
    .legend-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:.35rem;}
    .chart-wrap{position:relative;height:340px;}
    .text-danger{color:#e30613!important;}
    .text-warning{color:#e3a81e!important;}
    .text-success{color:#29a329!important;}
    .fw-bold{font-weight:700!important;}
    .pointer{cursor:pointer;}
    .details-row td{border-top:none;font-size:.9rem;}
    .details-row ul li{padding:3px 0;border-bottom:1px solid #eee;}
  </style>
</head>
<body>
<header class="app-header py-3">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    <h1 class="h4 m-0"><span class="brand-dot"></span>Portal de Análise de Incidentes</h1>
    <div class="d-flex gap-2">
      <input id="inputFile" type="file" class="form-control form-control-sm" accept=".xlsx,.xls,.csv"/>
      <button id="btnDemo" class="btn btn-outline-light btn-sm" title="Carrega dados de demonstração"><i class="bi bi-magic"></i> Demo</button>
    </div>
  </div>
</header>

<div class="container-fluid">
  <div class="row">
    <!-- ===== SIDEBAR ===== -->
    <nav class="col-12 col-md-3 col-lg-2 sidebar p-3">
      <div class="upload-drop mb-4" id="dropArea">
        <i class="bi bi-cloud-arrow-up fs-2 text-primary"></i>
        <p class="mb-1">Arraste e solte sua planilha aqui</p>
        <span class="small-note">Ou clique no campo acima</span>
      </div>

      <!-- Filtros -->
      <h6 class="text-uppercase text-muted mb-2">Filtros</h6>
      <div class="mb-2">
        <label class="form-label">Cluster</label>
        <select id="filtroCluster" class="form-select form-select-sm">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label">Cidade</label>
        <select id="filtroCidade" class="form-select form-select-sm">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="mb-2">
        <label class="form-label">Período</label>
        <div class="d-flex gap-1">
          <input id="filtroDataIni" type="date" class="form-control form-control-sm"/>
          <input id="filtroDataFim" type="date" class="form-control form-control-sm"/>
        </div>
      </div>
      <div class="d-grid gap-2 mt-2">
        <button class="btn btn-primary btn-sm" id="btnAplicarFiltros"><i class="bi bi-funnel"></i> Aplicar</button>
        <button class="btn btn-outline-secondary btn-sm" id="btnLimparFiltros"><i class="bi bi-x-circle"></i> Limpar</button>
      </div>

      <hr class="my-4"/>
      <div class="nav flex-column gap-1" role="tablist">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCluster" type="button"><i class="bi bi-diagram-3"></i> Incidentes por Cluster</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabQOE" type="button"><i class="bi bi-arrow-left-right"></i> QOE Pré vs Pós</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFechamento" type="button"><i class="bi bi-pie-chart"></i> Tipo de Fechamento</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabReinc" type="button"><i class="bi bi-clock-history"></i> Reincidência</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabResumo" type="button"><i class="bi bi-speedometer2"></i> Dashboard</button>
      </div>
    </nav>

    <!-- ===== MAIN ===== -->
    <main class="col-12 col-md-9 col-lg-10 p-3 p-md-4">
      <div class="tab-content">
        <!-- INCIDENTES -->
        <section class="tab-pane fade show active" id="tabCluster">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">Incidentes por Cluster</h5>
            <button class="btn btn-danger btn-sm" id="btnPDFCluster"><i class="bi bi-filetype-pdf"></i> Exportar PDF</button>
          </div>
          <div class="row">
            <div class="col-12 col-lg-5">
              <div class="table-responsive">
                <table class="table table-sm" id="tblCluster">
                  <thead><tr><th>Cluster</th><th class="text-end">Incidentes</th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            <div class="col-12 col-lg-7"><div class="chart-wrap"><canvas id="chartCluster"></canvas></div></div>
          </div>
        </section>

        <!-- QOE -->
        <section class="tab-pane fade" id="tabQOE">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">QOE Pré vs Pós</h5>
            <button class="btn btn-danger btn-sm" id="btnPDFQOE"><i class="bi bi-filetype-pdf"></i> Exportar PDF</button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm" id="tblQoeNode">
              <thead><tr>
                <th>Node</th><th>Cluster</th><th>Cidade</th>
                <th class="text-end"><strong>Pré</strong></th>
                <th class="text-end"><strong>Pós</strong></th>
                <th class="text-end">Variação</th><th>Status</th>
              </tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- FECHAMENTO -->
        <section class="tab-pane fade" id="tabFechamento">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">Tipo de Fechamento</h5>
            <button class="btn btn-danger btn-sm" id="btnPDFFechamento"><i class="bi bi-filetype-pdf"></i> Exportar PDF</button>
          </div>
          <div class="row">
            <div class="col-12 col-lg-6"><div class="chart-wrap"><canvas id="chartFechamento"></canvas></div></div>
            <div class="col-12 col-lg-6">
              <div class="table-responsive">
                <table class="table table-sm" id="tblFechamento">
                  <thead><tr><th>Tipo</th><th class="text-end">Volume</th><th class="text-end">% </th></tr></thead>
                  <tbody></tbody>
                </table>
              </div>
              <div id="legendFechamento" class="mt-2"></div>
            </div>
          </div>
        </section>

        <!-- REINCIDÊNCIA -->
        <section class="tab-pane fade" id="tabReinc">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">Log de Reincidência</h5>
            <button class="btn btn-danger btn-sm" id="btnPDFReinc"><i class="bi bi-filetype-pdf"></i> Exportar PDF</button>
          </div>
          <div class="table-responsive">
            <table class="table table-sm" id="tblReinc">
              <thead><tr><th>Node</th><th>Cluster</th><th>Cidade</th><th class="text-center">Ocorrências</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </section>

        <!-- DASHBOARD -->
        <section class="tab-pane fade" id="tabResumo">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">Dashboard Resumo</h5>
            <button class="btn btn-danger btn-sm" id="btnPDFResumo"><i class="bi bi-filetype-pdf"></i> Exportar PDF</button>
          </div>
          <div id="cardsResumo" class="row g-3"></div>
        </section>
      </div>
    </main>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ================= Helpers / Estado ================= */
const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const $=(s,c=document)=>c.querySelector(s);
let DATA_ALL=[], RAW=[], charts={};

/* ================= Mapeamento flexível de cabeçalhos ================= */
const AUTO_MAP={
  'INCIDENTE':'Tipo_Incidente','CIDADE':'Cidade','CLUSTER':'Cluster','NODE':'Node',
  'HI (DATA E HORA INICIO)':'Data','HI (DATA E HORA INÍCIO)':'Data','HI_INICIO':'Data','HI INICIO':'Data','HI INÍCIO':'Data','DATA':'Data',
  'QOE PRE':'QOE_Pre','QOE PRÉ':'QOE_Pre','QOE_PRE':'QOE_Pre',
  'QOE POS':'QOE_Pos','QOE PÓS':'QOE_Pos','QOE_POS':'QOE_Pos',
  'SOLUCAO':'Tipo_Fechamento','SOLUÇÃO':'Tipo_Fechamento','TIPO_FECHAMENTO':'Tipo_Fechamento'
};

function normalizeHeader(str) {
  return String(str || '')
    .trim()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // remove acentos
    .toUpperCase()
    .replace(/\s+/g, ' ');
}

/* ================= Proteções QOE ================= */
function safeVarPct(qpre,qpos){
  if(!isFinite(qpre)||qpre<=0) return 0;
  return ((qpos - qpre)/qpre)*100;
}
function fmtPct(n){
  if(!isFinite(n) || Math.abs(n)>1000) return '—';
  return `${n.toFixed(1)}%`;
}
function fmtNum(n){ return isFinite(n) ? n.toFixed(1) : '—'; }

/* ================= Upload / Demo ================= */
$('#inputFile').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(f) handleFile(f);
});
const dropArea=$('#dropArea');
;['dragenter','dragover'].forEach(evt=>dropArea.addEventListener(evt,e=>{
  e.preventDefault(); dropArea.classList.add('dragover');
}));
;['dragleave','drop'].forEach(evt=>dropArea.addEventListener(evt,e=>{
  e.preventDefault(); dropArea.classList.remove('dragover');
}));
dropArea.addEventListener('drop',e=>{
  const f=e.dataTransfer.files?.[0]; if(f) handleFile(f);
});
$('#btnDemo').addEventListener('click',()=>{
  DATA_ALL=makeDemoData(); RAW=[...DATA_ALL]; preencherFiltros();
  renderAll(); alert(`✅ ${RAW.length} incidentes carregados (DEMO)`);
});

/* ================= Leitura robusta da planilha ================= */
function handleFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=new Uint8Array(e.target.result);
      const wb=XLSX.read(data,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const json=XLSX.utils.sheet_to_json(ws,{defval:'',header:1});

      // Detecta a linha do cabeçalho (primeira linha não vazia)
      let headerRowIndex = json.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).trim() !== ''));
      if (headerRowIndex === -1) { alert('❌ Planilha vazia ou inválida'); return; }

      const rawHeader = (json[headerRowIndex]||[]).map(normalizeHeader);
      const mappedHeader = rawHeader.map(h => AUTO_MAP[h] || h);

      // Linhas úteis (descarta vazias)
      const dataRows = json.slice(headerRowIndex+1).filter(r => Array.isArray(r) && r.some(cell => String(cell).trim() !== ''));

      const rows = dataRows.map(r => {
        const o={};
        mappedHeader.forEach((h,i)=>o[h]=r[i]);
        // Conversões/limpezas
        if(o['Data']) {
          const d = new Date(o['Data']);
          o['Data'] = isNaN(d.getTime()) ? null : d;
        } else { o['Data']=null; }
        o['QOE_Pre']=Number(String(o['QOE_Pre']).toString().replace(',','.')); if(!isFinite(o['QOE_Pre'])) o['QOE_Pre']=0;
        o['QOE_Pos']=Number(String(o['QOE_Pos']).toString().replace(',','.')); if(!isFinite(o['QOE_Pos'])) o['QOE_Pos']=0;
        ['Cluster','Node','Cidade','Tipo_Incidente','Tipo_Fechamento'].forEach(k=>o[k]=String(o[k]||'').trim());
        return o;
      });

      if(rows.length===0){ alert('⚠️ Nenhum registro válido encontrado na planilha.'); return; }

      DATA_ALL=rows; RAW=[...rows];
      preencherFiltros(); renderAll();
      alert(`✅ ${rows.length} incidentes carregados com sucesso`);
    }catch(err){
      console.error(err);
      alert('❌ Erro ao processar a planilha. Verifique o formato e tente novamente.');
    }
  };
  reader.readAsArrayBuffer(file);
}

/* ================= Filtros ================= */
function preencherFiltros(){
  const clusters=[...new Set(DATA_ALL.map(r=>r.Cluster).filter(Boolean))].sort();
  $('#filtroCluster').innerHTML = '<option value="">Todos</option>' +
     clusters.map(c=>`<option value="${c}">${c}</option>`).join('');
  atualizarFiltroCidade();
}
$('#filtroCluster').addEventListener('change', atualizarFiltroCidade);
function atualizarFiltroCidade(){
  const cSel=$('#filtroCluster').value;
  const cidades=[...new Set(
    DATA_ALL.filter(r=>!cSel || r.Cluster===cSel).map(r=>r.Cidade).filter(Boolean)
  )].sort();
  $('#filtroCidade').innerHTML = '<option value="">Todas</option>' +
    cidades.map(c=>`<option value="${c}">${c}</option>`).join('');
}
$('#btnAplicarFiltros').addEventListener('click', aplicarFiltros);
$('#btnLimparFiltros').addEventListener('click', ()=>{
  $('#filtroCluster').value=''; $('#filtroCidade').value='';
  $('#filtroDataIni').value=''; $('#filtroDataFim').value='';
  RAW=[...DATA_ALL]; renderAll();
});
function aplicarFiltros(){
  const cl=$('#filtroCluster').value, ci=$('#filtroCidade').value;
  const di=$('#filtroDataIni').value? new Date($('#filtroDataIni').value): null;
  const df=$('#filtroDataFim').value? new Date($('#filtroDataFim').value): null;
  RAW=DATA_ALL.filter(r=>{
    let ok=true;
    if(cl) ok = ok && r.Cluster===cl;
    if(ci) ok = ok && r.Cidade===ci;
    if(di) ok = ok && r.Data && r.Data >= di;
    if(df){ const end=new Date(df); end.setHours(23,59,59,999); ok = ok && r.Data && r.Data <= end; }
    return ok;
  });
  renderAll();
}

/* ================= QOE ================= */
function colorByValue(v){
  if(!isFinite(v)) return '';
  if(v <= 40) return 'text-danger fw-bold';
  if(v <= 80) return 'text-warning fw-bold';
  return 'text-success fw-bold';
}
function aggregateQoe(rows,keys){
  const map=new Map();
  rows.forEach(r=>{
    const k=keys.map(k=>r[k]||'').join('||');
    const acc=map.get(k)||{cnt:0,qpre:0,qpos:0,Node:r.Node||'',Cluster:r.Cluster||'',Cidade:r.Cidade||''};
    acc.cnt++; acc.qpre+=isFinite(r.QOE_Pre)?r.QOE_Pre:0; acc.qpos+=isFinite(r.QOE_Pos)?r.QOE_Pos:0;
    map.set(k,acc);
  });
  return Array.from(map.values()).map(v=>{
    const pre=v.cnt?v.qpre/v.cnt:0;
    const pos=v.cnt?v.qpos/v.cnt:0;
    return {...v,qoePre:pre,qoePos:pos,varPct:safeVarPct(pre,pos)};
  });
}
function renderQoe(){
  const arr=aggregateQoe(RAW,['Node','Cluster','Cidade']);
  $('#tblQoeNode tbody').innerHTML = arr.map(r=>{
    const arrow=r.varPct>1?'<span class="text-success fw-bold"><i class="bi bi-arrow-up"></i></span>':'<span class="text-danger fw-bold"><i class="bi bi-arrow-down"></i></span>';
    const status=r.varPct>1?'<span class="text-success fw-bold">Melhoria</span>':'<span class="text-danger fw-bold">Piora/Estável</span>';
    return `<tr>
      <td>${r.Node}</td><td>${r.Cluster}</td><td>${r.Cidade}</td>
      <td class="text-end ${colorByValue(r.qoePre)}">${fmtNum(r.qoePre)}</td>
      <td class="text-end ${colorByValue(r.qoePos)}">${fmtNum(r.qoePos)}</td>
      <td class="text-end">${arrow} ${fmtPct(r.varPct)}</td>
      <td>${status}</td>
    </tr>`;
  }).join('');
}

/* ================= Incidentes por Cluster ================= */
function renderCluster(){
  const grp={}; RAW.forEach(r=>{grp[r.Cluster]=(grp[r.Cluster]||0)+1});
  const arr=Object.entries(grp).map(([c,v])=>({c,v})).sort((a,b)=>b.v-a.v);
  $('#tblCluster tbody').innerHTML=arr.map(({c,v})=>`<tr><td>${c||'(vazio)'}</td><td class="text-end">${v}</td></tr>`).join('');
  upsertBar('chartCluster','Incidentes',arr.map(x=>x.c||'(vazio)'),arr.map(x=>x.v),{indexAxis:'y'});
}

/* ================= Tipo de Fechamento ================= */
function renderFechamento(){
  const grp={}; RAW.forEach(r=>{grp[r.Tipo_Fechamento]=(grp[r.Tipo_Fechamento]||0)+1});
  const total=Object.values(grp).reduce((a,b)=>a+b,0)||1;
  const arr=Object.entries(grp).map(([t,v])=>({t,v})).sort((a,b)=>b.v-a.v);
  $('#tblFechamento tbody').innerHTML=arr.map(e=>`<tr>
    <td>${e.t||'(vazio)'}</td><td class="text-end">${e.v}</td><td class="text-end">${fmtPct(e.v/total*100)}</td>
  </tr>`).join('');
  upsertPie('chartFechamento',arr.map(e=>e.t||'(vazio)'),arr.map(e=>e.v));
  const colors=charts['chartFechamento']?.data.datasets[0].backgroundColor||[];
  $('#legendFechamento').innerHTML = arr.map((e,i)=>`<span class="legend-dot" style="background:${colors[i]||'#999'}"></span>${e.t||'(vazio)'}`).join('<br>');
}

/* ================= Reincidência (com detalhes) ================= */
function renderReinc(){
  const byNode=groupBy(RAW,'Node');
  const reinc=Object.entries(byNode)
    .filter(([_,list])=>list.length>1)
    .map(([n,l])=>({
      Node:n, Cluster:l[0].Cluster, Cidade:l[0].Cidade, Count:l.length,
      Incidents:l.map(x=>({id:x.Tipo_Incidente, solucao:x.Tipo_Fechamento}))
    })).sort((a,b)=>b.Count-a.Count);

  const tbody=$('#tblReinc tbody'); tbody.innerHTML='';
  reinc.forEach(r=>{
    const tr=document.createElement('tr'); tr.className='pointer';
    tr.innerHTML=`<td>${r.Node}</td><td>${r.Cluster}</td><td>${r.Cidade}</td><td class="text-center fw-bold">${r.Count}</td>`;
    tr.addEventListener('click',()=>toggleDetalhesNode(tr,r));
    tbody.appendChild(tr);
  });
}
function toggleDetalhesNode(tr,nodeData){
  if(tr.nextSibling && tr.nextSibling.classList.contains('details-row')){ tr.nextSibling.remove(); return; }
  $$('#tblReinc .details-row').forEach(el=>el.remove());
  const details=document.createElement('tr'); details.className='details-row bg-light';
  details.innerHTML = `<td colspan="4">
    <ul class="mb-0 list-unstyled">
      ${nodeData.Incidents.map(inc=>`<li><strong>${inc.id}</strong> - ${inc.solucao||'Sem solução'}</li>`).join('')}
    </ul>
  </td>`;
  tr.insertAdjacentElement('afterend', details);
}

/* ================= Dashboard ================= */
function renderResumo(){
  const byCluster=groupBy(RAW,'Cluster');
  const wrap=$('#cardsResumo'); wrap.innerHTML='';
  Object.entries(byCluster).forEach(([cl,rows])=>{
    const total=rows.length;
    const nodes=groupBy(rows,'Node');
    const reinc=Object.values(nodes).filter(a=>a.length>1).length;
    const taxa=total?(reinc/Object.keys(nodes).length*100):0;
    const varPct=aggregateQoe(rows,['Cluster'])[0]?.varPct||0;
    const qClass=varPct>0?'text-success fw-bold':'text-danger fw-bold';
    const rClass=taxa>20?'text-danger':'text-success';

    const card=document.createElement('div'); card.className='col-12 col-md-6 col-lg-4';
    card.innerHTML = `
      <div class="card h-100 shadow-sm border-0">
        <div class="card-body">
          <h5 class="mb-2">${cl||'(vazio)'}</h5>
          <p class="mb-1"><strong>${total}</strong> incidentes</p>
          <p class="mb-1">Δ QOE: <span class="${qClass}">${fmtPct(varPct)}</span></p>
          <p class="mb-0">Taxa Reinc.: <span class="${rClass}">${fmtPct(taxa)}</span></p>
        </div>
      </div>`;
    wrap.appendChild(card);
  });
}

/* ================= Charts ================= */
function upsertBar(id,label,labels,data,extra){
  const ctx=document.getElementById(id);
  if(charts[id]) charts[id].destroy();
  charts[id]=new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{ label, data }] },
    options:Object.assign({ responsive:true, plugins:{ legend:{ display:false } } }, extra||{})
  });
}
function upsertPie(id,labels,data){
  const ctx=document.getElementById(id);
  if(charts[id]) charts[id].destroy();
  charts[id]=new Chart(ctx,{ type:'pie', data:{ labels, datasets:[{ data }] }, options:{ responsive:true } });
}

/* ================= PDF ================= */
function exportTablePDF(title, tableSelector, chartId){
  const table=$(tableSelector);
  const head=Array.from(table.querySelectorAll('thead th')).map(th=>th.innerText);
  const rows=Array.from(table.querySelectorAll('tbody tr')).map(tr=>Array.from(tr.children).map(td=>td.innerText));

  let img=null;
  if(chartId && charts[chartId]) img = charts[chartId].toBase64Image();

  const docDef={
    pageSize:'A4', pageMargins:[24,24,24,24],
    content:[
      { text:title, style:'title' },
      { text:new Date().toLocaleString(), style:'sub', margin:[0,0,0,6] },
      img ? { image:img, width:480, margin:[0,0,0,12] } : {},
      { table:{ headerRows:1, widths:head.map(()=>'*'), body:[ head, ...rows ] }, layout:'lightHorizontalLines' }
    ],
    styles:{ title:{fontSize:16,bold:true}, sub:{fontSize:9,color:'#666'} }
  };
  pdfMake.createPdf(docDef).download(`${title.toLowerCase().replace(/[^a-z0-9]+/g,'_')}.pdf`);
}
$('#btnPDFCluster').addEventListener('click',()=>exportTablePDF('Incidentes por Cluster','#tblCluster','chartCluster'));
$('#btnPDFQOE').addEventListener('click',()=>exportTablePDF('QOE Pré vs Pós','#tblQoeNode',null));
$('#btnPDFFechamento').addEventListener('click',()=>exportTablePDF('Tipo de Fechamento','#tblFechamento','chartFechamento'));
$('#btnPDFReinc').addEventListener('click',()=>exportTablePDF('Log de Reincidência','#tblReinc',null));
$('#btnPDFResumo').addEventListener('click',()=>{
  const byCluster=groupBy(RAW,'Cluster');
  const head=['Cluster','Incidentes','Δ QOE','Taxa Reinc.'];
  const body=Object.entries(byCluster).map(([cl,rows])=>{
    const total=rows.length, nodes=groupBy(rows,'Node');
    const reinc=Object.values(nodes).filter(a=>a.length>1).length;
    const taxa=total?(reinc/Object.keys(nodes).length*100):0;
    const varPct=aggregateQoe(rows,['Cluster'])[0]?.varPct||0;
    return [ cl||'(vazio)', String(total), fmtPct(varPct), fmtPct(taxa) ];
  });
  const docDef={ pageSize:'A4', pageMargins:[24,24,24,24],
    content:[
      { text:'Dashboard Resumo', style:'title' },
      { text:new Date().toLocaleString(), style:'sub', margin:[0,0,0,6] },
      { table:{ headerRows:1, widths:['*','auto','auto','auto'], body:[ head, ...body ] }, layout:'lightHorizontalLines' }
    ],
    styles:{ title:{fontSize:16,bold:true}, sub:{fontSize:9,color:'#666'} }
  };
  pdfMake.createPdf(docDef).download('dashboard_resumo.pdf');
});

/* ================= Utils ================= */
function groupBy(a,k){ return a.reduce((acc,c)=>{ const key=c[k]||''; (acc[key]||(acc[key]=[])).push(c); return acc; },{}); }

/* ================= Demo generator ================= */
function makeDemoData(){
  const clusters=['RJ','SP','MG','ES'];
  const cidades={ RJ:['RIO DE JANEIRO','NITEROI'], SP:['SÃO PAULO','SANTOS'], MG:['BELO HORIZONTE'], ES:['VILA VELHA'] };
  const tipos=['MDU FILTRADO','SDU FILTRADO','NORMALIZADO SEM INTERVENÇÃO','CLEARDATE'];
  const out=[];
  for(let i=0;i<90;i++){
    const cl=clusters[Math.floor(Math.random()*clusters.length)];
    const ci=cidades[cl][Math.floor(Math.random()*cidades[cl].length)];
    const node='NODE-'+(100+Math.floor(Math.random()*900));
    const dt=new Date(2025,9,1+Math.floor(Math.random()*14), 6+Math.floor(Math.random()*12), Math.floor(Math.random()*60));
    const pre=Math.round(20+Math.random()*70);
    const pos=Math.round(pre + (-10 + Math.random()*30));
    out.push({
      Cluster:cl, Cidade:ci, Node:node, Data:dt,
      Tipo_Incidente:'INM'+(10000000+i),
      Tipo_Fechamento:tipos[Math.floor(Math.random()*tipos.length)],
      QOE_Pre:pre, QOE_Pos:pos
    });
  }
  return out;
}

/* ================= Render inicial ================= */
function renderAll(){ renderCluster(); renderQoe(); renderFechamento(); renderReinc(); renderResumo(); }
</script>
</body>
</html>
