<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Portal de Análise de Incidentes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/vfs_fonts.js"></script>
  <style>
    :root {
      --claro-red:#e30613;--claro-green:#29a329;--claro-yellow:#e3a81e;
      --claro-blue:#0066cc;--claro-danger:#d62828;--bg-soft:#f7f7f7;
    }
    body{background:var(--bg-soft);}
    .app-header{background:#1a1a1a;color:#fff;}
    .brand-dot{width:.75rem;height:.75rem;border-radius:50%;background:var(--claro-red);display:inline-block;margin-right:.5rem;}
    .sidebar{min-height:100vh;background:#fff;border-right:1px solid #e9ecef;}
    .sidebar .nav-link.active{background:var(--claro-red);color:#fff;}
    .upload-drop{border:2px dashed var(--claro-blue);border-radius:.75rem;padding:1.25rem;text-align:center;background:#fff;}
    .upload-drop.dragover{background:#eef6ff;border-color:var(--claro-red);}
    .legend-dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:.35rem;}
    .chart-wrap{position:relative;height:340px;}
  </style>
</head>
<body>
<header class="app-header py-3">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    <h1 class="h4 m-0"><span class="brand-dot"></span>Portal de Análise de Incidentes</h1>
    <div class="d-flex gap-2">
      <input id="inputFile" type="file" class="form-control form-control-sm" accept=".xlsx,.xls,.csv"/>
      <button id="btnDemo" class="btn btn-outline-light btn-sm"><i class="bi bi-magic"></i> Demo</button>
    </div>
  </div>
</header>

<div class="container-fluid">
  <div class="row">
    <nav class="col-12 col-md-3 col-lg-2 sidebar p-3">
      <div class="upload-drop mb-4" id="dropArea">
        <i class="bi bi-cloud-arrow-up fs-2 text-primary"></i>
        <p class="mb-1">Arraste e solte sua planilha aqui</p>
        <span class="small-note">Ou clique no campo acima</span>
      </div>
      <div class="nav flex-column gap-1" role="tablist">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCluster" type="button"><i class="bi bi-diagram-3"></i> Incidentes por Cluster</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabQOE" type="button"><i class="bi bi-arrow-left-right"></i> QOE Pré vs Pós</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFechamento" type="button"><i class="bi bi-pie-chart"></i> Tipo de Fechamento</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabReinc" type="button"><i class="bi bi-clock-history"></i> Reincidência</button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabResumo" type="button"><i class="bi bi-speedometer2"></i> Dashboard</button>
      </div>
    </nav>
    <main class="col-12 col-md-9 col-lg-10 p-3 p-md-4">
      <div class="tab-content">
        <section class="tab-pane fade show active" id="tabCluster">
          <h5>Incidentes por Cluster</h5>
          <div class="row">
            <div class="col-12 col-lg-5">
              <table class="table table-sm" id="tblCluster">
                <thead><tr><th>Cluster</th><th>Incidentes</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="col-12 col-lg-7"><div class="chart-wrap"><canvas id="chartCluster"></canvas></div></div>
          </div>
        </section>

        <section class="tab-pane fade" id="tabQOE">
          <h5>QOE Pré vs Pós</h5>
          <table class="table table-sm" id="tblQoeNode">
            <thead><tr><th>Node</th><th>Cluster</th><th>Cidade</th><th>Pré</th><th>Pós</th><th>Variação</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <section class="tab-pane fade" id="tabFechamento">
          <h5>Tipo de Fechamento</h5>
          <div class="row">
            <div class="col-12 col-lg-6"><div class="chart-wrap"><canvas id="chartFechamento"></canvas></div></div>
            <div class="col-12 col-lg-6">
              <table class="table table-sm" id="tblFechamento">
                <thead><tr><th>Tipo</th><th>Volume</th><th>%</th></tr></thead><tbody></tbody>
              </table>
              <div id="legendFechamento"></div>
            </div>
          </div>
        </section>

        <section class="tab-pane fade" id="tabReinc">
          <h5>Log de Reincidência</h5>
          <table class="table table-sm" id="tblReinc">
            <thead><tr><th>Node</th><th>Cluster</th><th>Cidade</th><th>Data</th><th>Tipo</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </section>

        <section class="tab-pane fade" id="tabResumo">
          <h5>Dashboard Resumo</h5>
          <div id="cardsResumo" class="row g-3"></div>
        </section>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const $=(s,c=document)=>c.querySelector(s);
let RAW=[],DATA_ALL=[],charts={};

const AUTO_MAP={
 'INCIDENTE':'Tipo_Incidente','CIDADE':'Cidade','CLUSTER':'Cluster',
 'HI (DATA E HORA INÍCIO)':'Data','NODE':'Node','RET':'RET',
 'QOE PRÉ':'QOE_Pre','QOE PÓS':'QOE_Pos',
 'SOLUÇÃO':'Tipo_Fechamento','HF (DATA E HORA FIM)':'Data_Fim',
 'OBSERVAÇÃO':'Observacao','OUTAGE DE MDU VINCULADO':'Outage_MDU'
};

// Upload
$('#inputFile').addEventListener('change',e=>{
 const f=e.target.files?.[0];if(f)handleFile(f);
});
$('#dropArea').addEventListener('drop',e=>{
 e.preventDefault();const f=e.dataTransfer.files?.[0];if(f)handleFile(f);
});
;['dragenter','dragover'].forEach(evt=>$('#dropArea').addEventListener(evt,e=>{e.preventDefault();$('#dropArea').classList.add('dragover');}));
;['dragleave','drop'].forEach(evt=>$('#dropArea').addEventListener(evt,e=>{e.preventDefault();$('#dropArea').classList.remove('dragover');}));

$('#btnDemo').addEventListener('click',()=>{DATA_ALL=makeDemoData();RAW=[...DATA_ALL];alert(`✅ ${RAW.length} incidentes carregados (DEMO)`);renderAll();});

function handleFile(file){
 const reader=new FileReader();
 reader.onload=e=>{
   const data=new Uint8Array(e.target.result);
   const wb=XLSX.read(data,{type:'array'});
   const ws=wb.Sheets[wb.SheetNames[0]];
   let json=XLSX.utils.sheet_to_json(ws,{defval:'',header:1});
   const header=json[0].map(h=>String(h).trim());
   console.log("Cabeçalhos detectados:",header);
   const mappedHeader=header.map(h=>AUTO_MAP[h.toUpperCase()]||h);
   const rows=json.slice(1).map(r=>{
     const o={};mappedHeader.forEach((h,i)=>o[h]=r[i]);
     if(o['Data']) o['Data']=new Date(o['Data']);
     if(o['QOE_Pre']) o['QOE_Pre']=Number(o['QOE_Pre']);
     if(o['QOE_Pos']) o['QOE_Pos']=Number(o['QOE_Pos']);
     return o;
   });
   DATA_ALL=rows;RAW=[...rows];
   alert(`✅ ${rows.length} incidentes carregados com sucesso`);
   renderAll();
 };
 reader.readAsArrayBuffer(file);
}

function renderAll(){renderCluster();renderQoe();renderFechamento();renderReinc();renderResumo();}

function renderCluster(){
 const grp=countBy(RAW,'Cluster');
 const arr=Object.entries(grp).map(([k,v])=>({Cluster:k,Inc:v})).sort((a,b)=>b.Inc-a.Inc);
 $('#tblCluster tbody').innerHTML=arr.map(r=>`<tr><td>${r.Cluster}</td><td>${r.Inc}</td></tr>`).join('');
 upsertBar('chartCluster','Incidentes',arr.map(r=>r.Cluster),arr.map(r=>r.Inc),{indexAxis:'y'});
}

function renderQoe(){
 const byNode=aggregateQoe(RAW,['Node','Cluster','Cidade']);
 $('#tblQoeNode tbody').innerHTML=byNode.map(r=>rowQoeHtml(r)).join('');
}
function rowQoeHtml(r){
 const s=statusFromDelta(r.varPct);
 return `<tr><td>${r.Node}</td><td>${r.Cluster}</td><td>${r.Cidade}</td><td>${fmtNum(r.qoePre)}</td><td>${fmtNum(r.qoePos)}</td><td>${fmtPct(r.varPct)}</td><td>${s}</td></tr>`;
}
function aggregateQoe(rows,keys){
 const map=new Map();
 rows.forEach(r=>{
   const k=keys.map(k=>r[k]||'').join('||');
   const acc=map.get(k)||{cnt:0,qpre:0,qpos:0,Node:r.Node||'',Cluster:r.Cluster||'',Cidade:r.Cidade||''};
   acc.cnt++;acc.qpre+=r.QOE_Pre||0;acc.qpos+=r.QOE_Pos||0;
   map.set(k,acc);
 });
 return Array.from(map.values()).map(v=>{
   const qpre=v.cnt?v.qpre/v.cnt:0;const qpos=v.cnt?v.qpos/v.cnt:0;
   return {...v,qoePre:qpre,qoePos:qpos,varPct:qpre?((qpos-qpre)/qpre*100):0};
 });
}

function renderFechamento(){
 const grp=countBy(RAW,'Tipo_Fechamento');
 const total=Object.values(grp).reduce((a,b)=>a+b,0)||1;
 const arr=Object.entries(grp).map(([t,v])=>({t,v}));
 $('#tblFechamento tbody').innerHTML=arr.map(e=>`<tr><td>${e.t}</td><td>${e.v}</td><td>${fmtPct((e.v/total)*100)}</td></tr>`).join('');
 upsertPie('chartFechamento',arr.map(e=>e.t),arr.map(e=>e.v));
 const colors=charts['chartFechamento']?.data.datasets[0].backgroundColor||[];
 $('#legendFechamento').innerHTML=arr.map((e,i)=>`<span class="legend-dot" style="background:${colors[i]}"></span>${e.t}`).join('<br>');
}

function renderReinc(){
 const byNode=groupBy(RAW,'Node');
 $('#tblReinc tbody').innerHTML=RAW.map(r=>{
   const st=(byNode[r.Node]?.length>1)?'Reincidente':'Único';
   return `<tr><td>${r.Node}</td><td>${r.Cluster}</td><td>${r.Cidade}</td><td>${fmtDate(r.Data)}</td><td>${r.Tipo_Incidente}</td><td>${st}</td></tr>`;
 }).join('');
}

function renderResumo(){
 const byCluster=groupBy(RAW,'Cluster');
 const wrap=$('#cardsResumo');wrap.innerHTML='';
 Object.entries(byCluster).forEach(([cluster,rows])=>{
   const total=rows.length;
   const nodes=groupBy(rows,'Node');
   const reinc=Object.values(nodes).filter(a=>a.length>1).length;
   const taxa=total?(reinc/Object.keys(nodes).length*100):0;
   const varPct=aggregateQoe(rows,['Cluster'])[0]?.varPct||0;
   const card=document.createElement('div');
   card.className='col-12 col-md-6 col-lg-4';
   card.innerHTML=`<div class='card p-3'><h6>${cluster}</h6><p>${total} incidentes</p><p>Taxa Reinc.: ${fmtPct(taxa)}</p><p>Δ QOE: ${fmtPct(varPct)}</p></div>`;
   wrap.appendChild(card);
 });
}

function statusFromDelta(p){if(p>2)return'Melhoria';if(p<-2)return'Piora';return'Estável';}
function upsertBar(id,label,labels,data,opts){
 const ctx=document.getElementById(id);
 if(charts[id])charts[id].destroy();
 charts[id]=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label,data}]},options:Object.assign({responsive:true,maintainAspectRatio:false},opts)});
}
function upsertPie(id,labels,data){
 const ctx=document.getElementById(id);
 if(charts[id])charts[id].destroy();
 charts[id]=new Chart(ctx,{type:'pie',data:{labels,datasets:[{data}]},options:{responsive:true}});
}

function countBy(arr,key){return arr.reduce((a,c)=>{const k=c[key]||'';a[k]=(a[k]||0)+1;return a;},{});}
function groupBy(arr,key){return arr.reduce((a,c)=>{const k=c[key]||'';(a[k]||(a[k]=[])).push(c);return a;},{});}
function fmtPct(n){return isFinite(n)?`${n.toFixed(1)}%`:'—';}
function fmtNum(n){return isFinite(n)?n.toFixed(1):'—';}
function fmtDate(d){return d?new Date(d).toLocaleString():'—';}

function makeDemoData(){
 const clusters=['RJ','ES','MG'];
 const cidades={RJ:['RIO DE JANEIRO'],ES:['VILA VELHA'],MG:['BELO HORIZONTE']};
 const tipos=['MDU FILTRADO','SDU FILTRADO','NORMALIZADO SEM INTERVENÇÃO'];
 const out=[];
 for(let i=0;i<57;i++){
   const c=clusters[Math.floor(Math.random()*clusters.length)];
   const ci=cidades[c][0];
   const node='NODE-'+(100+Math.floor(Math.random()*900));
   const dt=new Date(2025,9,10+Math.floor(Math.random()*5),6+Math.floor(Math.random()*12));
   const pre=20+Math.random()*50;const pos=pre+(-10+Math.random()*40);
   out.push({Cluster:c,Cidade:ci,Node:node,Data:dt,Tipo_Incidente:'INM'+(10000000+i),Tipo_Fechamento:tipos[Math.floor(Math.random()*tipos.length)],QOE_Pre:Math.round(pre),QOE_Pos:Math.round(pos)});
 }
 return out;
}
</script>
</body>
</html>
