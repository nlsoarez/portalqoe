<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Portal de Análise de Incidentes</title>

  <!-- CSS & Libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/vfs_fonts.js"></script>

  <style>
    :root {
      --primary: #2e7d32;
      --primary-dark: #1b5e20;
      --primary-light: #4caf50;
      --secondary: #a5d6a7;
      --accent: #81c784;
      --light-bg: linear-gradient(135deg, #f8fdf8 0%, #f0f7ff 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --card-bg-hover: rgba(255, 255, 255, 0.98);
      --text-dark: #1a1a1a;
      --text-muted: #5a5a5a;
      --border-color: rgba(0, 0, 0, 0.08);
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --info: #2196f3;
      --shadow-sm: 0 2px 12px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 8px 30px rgba(0, 0, 0, 0.12);
      --shadow-lg: 0 16px 50px rgba(0, 0, 0, 0.15);
      --glass: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.18);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      background: var(--light-bg);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      color: var(--text-dark);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      padding-bottom: 50px; /* Espaço para a assinatura */
    }
    
    .app-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    .app-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.1;
    }
    
    .brand-dot {
      width: .75rem;
      height: .75rem;
      border-radius: 50%;
      background: #fff;
      display: inline-block;
      margin-right: .5rem;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    .sidebar {
      min-height: 100vh;
      background: var(--card-bg);
      border-right: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 10;
    }
    
    .sidebar::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(46, 125, 50, 0.03) 0%, rgba(33, 150, 243, 0.03) 100%);
      z-index: -1;
    }
    
    .sidebar .nav-link {
      border-radius: 12px;
      margin-bottom: 8px;
      color: var(--text-muted);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 12px 16px;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }
    
    .sidebar .nav-link::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      transition: left 0.6s;
    }
    
    .sidebar .nav-link:hover {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(33, 150, 243, 0.1) 100%);
      color: var(--primary);
      transform: translateX(5px);
      box-shadow: var(--shadow-sm);
    }
    
    .sidebar .nav-link:hover::before {
      left: 100%;
    }
    
    .sidebar .nav-link.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff;
      box-shadow: var(--shadow-md);
      transform: translateX(0);
    }
    
    .upload-drop {
      border: 2px dashed var(--accent);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      background: var(--glass);
      backdrop-filter: blur(10px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .upload-drop::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(33, 150, 243, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .upload-drop:hover, .upload-drop.dragover {
      background: var(--glass);
      border-color: var(--primary);
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .upload-drop:hover::before, .upload-drop.dragover::before {
      opacity: 1;
    }
    
    .chart-wrap {
      position: relative;
      height: 380px;
      background: var(--card-bg);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(10px);
      overflow: hidden;
      opacity: 0;
      transform: translateY(20px);
      animation: chartEntrance 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    @keyframes chartEntrance {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .chart-wrap::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.02) 0%, rgba(33, 150, 243, 0.02) 100%);
      z-index: -1;
    }
    
    .card-custom {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(10px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      opacity: 0;
      transform: translateY(20px);
      animation: cardEntrance 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    @keyframes cardEntrance {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .card-custom:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--shadow-lg);
      background: var(--card-bg-hover);
    }
    
    .card-custom::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--info));
      transform: scaleX(0);
      transition: transform 0.4s ease;
    }
    
    .card-custom:hover::before {
      transform: scaleX(1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border: none;
      border-radius: 12px;
      padding: 10px 20px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.6s;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .btn-primary:hover::before {
      left: 100%;
    }
    
    .section-title {
      color: var(--primary);
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-color);
      position: relative;
      font-size: 1.25rem;
    }
    
    .section-title::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 60px;
      height: 2px;
      background: linear-gradient(90deg, var(--primary), var(--info));
      border-radius: 2px;
    }
    
    .table-hover tbody tr:hover {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.05) 0%, rgba(33, 150, 243, 0.05) 100%);
      transform: translateX(5px);
      transition: all 0.3s ease;
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }
    
    .badge-success {
      background: linear-gradient(135deg, var(--success) 0%, #66bb6a 100%);
      color: white;
    }
    
    .badge-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #ef5350 100%);
      color: white;
    }
    
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
      border-radius: 16px;
      backdrop-filter: blur(10px);
    }
    
    .cluster-row {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 8px;
    }
    
    .cluster-row:hover {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.1) 0%, rgba(33, 150, 243, 0.1) 100%) !important;
      transform: translateX(5px);
      box-shadow: var(--shadow-sm);
    }
    
    .cluster-row.selected {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(33, 150, 243, 0.15) 100%) !important;
      font-weight: 600;
      border-left: 4px solid var(--primary);
      box-shadow: var(--shadow-sm);
    }
    
    .back-button {
      margin-bottom: 15px;
      opacity: 0;
      animation: fadeIn 0.5s ease 0.3s forwards;
    }
    
    .details-content {
      border-left: 4px solid var(--primary);
      border-radius: 0 12px 12px 0;
      background: linear-gradient(135deg, rgba(248, 249, 250, 0.8) 0%, rgba(233, 236, 239, 0.6) 100%);
    }
    
    .table-active {
      background: linear-gradient(135deg, rgba(46, 125, 50, 0.1) 0%, rgba(33, 150, 243, 0.1) 100%) !important;
      font-weight: 600;
    }
    
    .expand-icon {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    
    .details-row {
      background: linear-gradient(135deg, rgba(248, 249, 250, 0.9) 0%, rgba(233, 236, 239, 0.7) 100%);
      backdrop-filter: blur(10px);
    }
    
    .badge.rounded-pill {
      font-size: 0.75rem;
      padding: 6px 12px;
      font-weight: 600;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .slide-in-up {
      animation: slideInUp 0.7s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .tab-pane {
      animation: fadeIn 0.5s ease-out;
    }
    
    /* Assinatura discreta e centralizada */
    .assinatura {
      position: fixed;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(150, 150, 150, 0.1);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.65rem;
      color: #666;
      backdrop-filter: blur(5px);
      z-index: 1000;
      animation: fadeIn 0.8s ease-out;
      border: 1px solid rgba(0, 0, 0, 0.05);
      text-align: center;
      max-width: 90%;
    }
    
    .assinatura strong {
      color: #555;
      font-weight: 500;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        min-height: auto;
        border-right: none;
        border-bottom: 1px solid var(--border-color);
      }
      
      .chart-wrap {
        height: 300px;
      }
      
      .card-custom:hover {
        transform: none;
      }
      
      .assinatura {
        position: relative;
        bottom: auto;
        left: auto;
        transform: none;
        margin: 20px auto 10px;
        width: 90%;
        border-radius: 8px;
      }
    }
  </style>
</head>
<body>
<header class="app-header py-3">
  <div class="container-fluid d-flex justify-content-between align-items-center">
    <h1 class="h4 m-0 fw-bold"><span class="brand-dot"></span>Portal de Análise de Incidentes</h1>
  </div>
</header>

<div class="container-fluid">
  <div class="row">
    <!-- ===== SIDEBAR ===== -->
    <nav class="col-12 col-md-3 col-lg-2 sidebar p-4">
      <div class="upload-drop mb-4" id="dropArea">
        <i class="bi bi-cloud-arrow-up fs-2 text-primary mb-3"></i>
        <p class="mb-1 fw-semibold">Arraste e solte sua planilha aqui</p>
        <span class="small-note text-muted">Suporta XLSX, XLS e CSV</span>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
      </div>

      <hr class="my-4"/>
      <div class="nav flex-column gap-2" role="tablist">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabCluster" type="button" id="tabClusterBtn">
          <i class="bi bi-diagram-3 me-2"></i>Incidentes por Cluster
        </button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCidade" type="button" id="tabCidadeBtn">
          <i class="bi bi-geo-alt me-2"></i>Incidentes por Cidade
        </button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabQOE" type="button">
          <i class="bi bi-arrow-left-right me-2"></i>QOE Pré vs Pós
        </button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabFechamento" type="button">
          <i class="bi bi-pie-chart me-2"></i>Tipo de Fechamento
        </button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabReinc" type="button">
          <i class="bi bi-clock-history me-2"></i>Reincidência
        </button>
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabResumo" type="button">
          <i class="bi bi-speedometer2 me-2"></i>Dashboard
        </button>
      </div>
    </nav>

    <!-- ===== MAIN ===== -->
    <main class="col-12 col-md-9 col-lg-10 p-4 p-md-5">
      <div class="tab-content">
        <!-- INCIDENTES POR CLUSTER -->
        <section class="tab-pane fade show active" id="tabCluster">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="m-0 section-title">Incidentes por Cluster</h5>
            <button class="btn btn-primary btn-sm" id="btnPDFCluster">
              <i class="bi bi-filetype-pdf me-1"></i> Exportar PDF
            </button>
          </div>
          <div class="row">
            <div class="col-12 col-lg-5 mb-4">
              <div class="card-custom p-4 h-100">
                <div class="table-responsive">
                  <table class="table table-sm table-hover" id="tblCluster">
                    <thead class="table-light">
                      <tr>
                        <th>Cluster</th>
                        <th class="text-end">Incidentes</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-7 mb-4">
              <div class="chart-wrap">
                <canvas id="chartCluster"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- INCIDENTES POR CIDADE -->
        <section class="tab-pane fade" id="tabCidade">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <button class="btn btn-outline-secondary btn-sm back-button" id="btnVoltarCluster" style="display: none;">
                <i class="bi bi-arrow-left me-1"></i> Voltar para Clusters
              </button>
              <h5 class="m-0 section-title" id="tituloCidade">Incidentes por Cidade</h5>
            </div>
            <button class="btn btn-primary btn-sm" id="btnPDFCidade">
              <i class="bi bi-filetype-pdf me-1"></i> Exportar PDF
            </button>
          </div>
          <div class="row">
            <div class="col-12 col-lg-5 mb-4">
              <div class="card-custom p-4 h-100">
                <div class="table-responsive">
                  <table class="table table-sm table-hover" id="tblCidade">
                    <thead class="table-light">
                      <tr>
                        <th>Cidade</th>
                        <th class="text-end">Incidentes</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="col-12 col-lg-7 mb-4">
              <div class="chart-wrap">
                <canvas id="chartCidade"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- QOE -->
        <section class="tab-pane fade" id="tabQOE">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="m-0 section-title">QOE Pré vs Pós</h5>
            <button class="btn btn-primary btn-sm" id="btnPDFQOE">
              <i class="bi bi-filetype-pdf me-1"></i> Exportar PDF
            </button>
          </div>
          <div class="card-custom p-4">
            <div class="table-responsive">
              <table class="table table-sm table-hover" id="tblQoeNode">
                <thead class="table-light">
                  <tr>
                    <th>Node</th>
                    <th>Cluster</th>
                    <th>Cidade</th>
                    <th class="text-end"><strong>Pré</strong></th>
                    <th class="text-end"><strong>Pós</strong></th>
                    <th class="text-end"><strong>QOE 24h</strong></th>
                    <th class="text-end">Melhoria %</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- FECHAMENTO -->
        <section class="tab-pane fade" id="tabFechamento">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="m-0 section-title">Tipo de Fechamento</h5>
            <button class="btn btn-primary btn-sm" id="btnPDFFechamento">
              <i class="bi bi-filetype-pdf me-1"></i> Exportar PDF
            </button>
          </div>
          <div class="row">
            <div class="col-12 col-lg-6 mb-4">
              <div class="chart-wrap">
                <canvas id="chartFechamento"></canvas>
              </div>
            </div>
            <div class="col-12 col-lg-6 mb-4">
              <div class="card-custom p-4 h-100">
                <div class="table-responsive">
                  <table class="table table-sm table-hover" id="tblFechamento">
                    <thead class="table-light">
                      <tr>
                        <th>Tipo</th>
                        <th class="text-end">Volume</th>
                        <th class="text-end">% </th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- REINCIDÊNCIA -->
        <section class="tab-pane fade" id="tabReinc">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="m-0 section-title">Log de Reincidência</h5>
            <button class="btn btn-primary btn-sm" id="btnPDFReinc">
              <i class="bi bi-filetype-pdf me-1"></i> Exportar PDF
            </button>
          </div>
          <div class="card-custom p-4">
            <div class="table-responsive">
              <table class="table table-sm table-hover" id="tblReinc">
                <thead class="table-light">
                  <tr>
                    <th>Node</th>
                    <th>Cluster</th>
                    <th>Cidade</th>
                    <th class="text-center">Ocorrências</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- DASHBOARD -->
        <section class="tab-pane fade" id="tabResumo">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="m-0 section-title">Dashboard Resumo</h5>
            <button class="btn btn-primary btn-sm" id="btnPDFResumo">
              <i class="bi bi-filetype-pdf me-1"></i> Exportar PDF
            </button>
          </div>
          <div id="cardsResumo" class="row g-4"></div>
        </section>
      </div>
    </main>
  </div>
</div>

<!-- Assinatura discreta -->
<div class="assinatura">
  <strong>Desenvolvido por:</strong> N6105010 e N5923221
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ================= Helpers / Estado ================= */
const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));
const $=(s,c=document)=>c.querySelector(s);
let DATA_ALL=[], RAW=[], charts={};
let selectedCluster = null;

/* ================= Mapeamento flexível de cabeçalhos ================= */
const AUTO_MAP={
  'INCIDENTE':'INCIDENTE',
  'CIDADE':'Cidade',
  'CLUSTER':'Cluster',
  'HI (DATA E HORA INÍCIO)':'Data',
  'HI (DATA E HORA INICIO)':'Data',
  'HI_INICIO':'Data',
  'HI INICIO':'Data',
  'HI INÍCIO':'Data',
  'DATA':'Data',
  'DATA INICIO':'Data',
  'DATA INÍCIO':'Data',
  'NODE':'Node',
  'NÓ':'Node',
  'QOE PRÉ':'QOE_Pre',
  'QOE PRE':'QOE_Pre',
  'QOE_PRE':'QOE_Pre',
  'QOE PRE INCIDENTE':'QOE_Pre',
  'QOE PÓS':'QOE_Pos',
  'QOE POS':'QOE_Pos',
  'QOE_POS':'QOE_Pos',
  'QOE PÓS INCIDENTE':'QOE_Pos',
  'QOE 24H':'QOE_24h',
  'QOE_24H':'QOE_24h',
  'QOE24H':'QOE_24h',
  'QOE 24H PÓS':'QOE_24h',
  'SOLUÇÃO':'Tipo_Fechamento',
  'SOLUCAO':'Tipo_Fechamento',
  'TIPO_FECHAMENTO':'Tipo_Fechamento',
  'TIPO SOLUCAO':'Tipo_Fechamento',
  'TIPO SOLUÇÃO':'Tipo_Fechamento'
};

function normalizeHeader(str) {
  return String(str || '')
    .trim()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .toUpperCase()
    .replace(/\s+/g, ' ')
    .replace(/[^A-Z0-9\s]/g, '');
}

/* ================= Cálculo de Melhoria e Status ================= */
function calcularMelhoriaStatus(qpre, qpos, q24h) {
  // Determinar qual QoE usar (24h tem prioridade absoluta)
  const qoeUsado = (q24h !== undefined && q24h !== null && q24h !== 0 && isFinite(q24h)) ? q24h : 
                   (qpos !== undefined && qpos !== null && qpos !== 0 && isFinite(qpos)) ? qpos : null;
  
  // Verificar se temos dados suficientes para cálculo
  if (!isFinite(qpre) || qpre <= 0 || qoeUsado === null) {
    return { melhoria: null, status: '—' };
  }
  
  // Calcular melhoria percentual
  const melhoria = ((qoeUsado - qpre) / qpre) * 100;
  
  // Determinar status
  const status = melhoria > 0 ? 'Melhorando' : 'Piorando';
  
  return { melhoria, status };
}

/* ================= Proteções QOE ================= */
function fmtPct(n){
  if(!isFinite(n) || n === null) return '—';
  return `${n > 0 ? '+' : ''}${n.toFixed(1)}%`;
}

function fmtNum(n){ 
  return isFinite(n) && n !== null && n !== 0 ? n.toFixed(1) : '—'; 
}

/* ================= Validação de Datas ================= */
function validarData(dataStr) {
  if (!dataStr || dataStr === '') return null;
  
  if (dataStr instanceof Date && !isNaN(dataStr.getTime())) {
    return dataStr;
  }
  
  dataStr = String(dataStr).trim();
  
  let data = new Date(dataStr);
  if (!isNaN(data.getTime())) return data;
  
  if (dataStr.includes('/')) {
    const partes = dataStr.split(/[/\s:]/);
    if (partes.length >= 3) {
      let dia = parseInt(partes[0]);
      let mes = parseInt(partes[1]) - 1;
      let ano = parseInt(partes[2]);
      
      if (mes > 11) {
        [dia, mes] = [mes + 1, dia - 1];
      }
      
      data = new Date(ano, mes, dia);
      if (!isNaN(data.getTime())) return data;
    }
  }
  
  data = new Date(dataStr.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1'));
  if (!isNaN(data.getTime())) return data;
  
  return null;
}

/* ================= Upload ================= */
const dropArea=$('#dropArea');
const fileInput = $('#fileInput');

['dragenter','dragover'].forEach(evt=>dropArea.addEventListener(evt,e=>{
  e.preventDefault(); 
  dropArea.classList.add('dragover');
}));
['dragleave','drop'].forEach(evt=>dropArea.addEventListener(evt,e=>{
  e.preventDefault(); 
  dropArea.classList.remove('dragover');
}));
dropArea.addEventListener('drop',e=>{
  const f=e.dataTransfer.files?.[0]; 
  if(f) {
    showLoading();
    setTimeout(() => {
      handleFile(f);
      hideLoading();
    }, 500);
  }
});

dropArea.addEventListener('click', () => {
  fileInput.click();
});

fileInput.addEventListener('change',e=>{
  const f=e.target.files?.[0]; 
  if(f) {
    showLoading();
    setTimeout(() => {
      handleFile(f);
      hideLoading();
    }, 500);
  }
});

/* ================= Leitura da planilha ================= */
function handleFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=new Uint8Array(e.target.result);
      const wb=XLSX.read(data,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      
      const json=XLSX.utils.sheet_to_json(ws,{defval:'',header:1});

      let headerRowIndex = json.findIndex(row => Array.isArray(row) && row.some(cell => String(cell).trim() !== ''));
      if (headerRowIndex === -1) { 
        showToast('❌ Planilha vazia ou inválida', 'danger');
        return; 
      }

      const rawHeader = (json[headerRowIndex]||[]).map(normalizeHeader);
      const mappedHeader = rawHeader.map(h => AUTO_MAP[h] || h);

      const dataRows = json.slice(headerRowIndex+1).filter(r => Array.isArray(r) && r.some(cell => String(cell).trim() !== ''));

      const rows = dataRows.map(r => {
        const o={};
        mappedHeader.forEach((h,i)=>{
          if (h && h !== '') {
            o[h] = r[i];
          }
        });
        
        o['Data'] = validarData(String(o['Data'] || ''));
        
        ['QOE_Pre', 'QOE_Pos', 'QOE_24h'].forEach(key => {
          if (o[key] !== undefined) {
            let value = String(o[key]).replace(',','.').replace(/[^\d.-]/g, '');
            o[key] = value ? Number(value) : 0;
            if(!isFinite(o[key]) || isNaN(o[key])) o[key] = 0;
          } else {
            o[key] = 0;
          }
        });
        
        ['Cluster','Node','Cidade','Tipo_Fechamento','INCIDENTE'].forEach(k=>{
          o[k] = String(o[k] || '').trim();
          if(o[k]==='') o[k]='(não informado)';
        });
        
        return o;
      }).filter(row => 
        row.Cluster !== '(não informado)' || 
        row.Node !== '(não informado)' || 
        row.Cidade !== '(não informado)' ||
        row.QOE_Pre > 0 || 
        row.QOE_Pos > 0
      );

      if(rows.length===0){ 
        showToast('⚠️ Nenhum registro válido encontrado na planilha.', 'warning'); 
        return; 
      }

      DATA_ALL=rows; RAW=[...rows];
      
      renderAll();
      showToast(`✅ ${rows.length} incidentes carregados com sucesso`, 'success');
    }catch(err){
      console.error('Erro detalhado:', err);
      showToast('❌ Erro ao processar a planilha. Verifique o formato e tente novamente.', 'danger');
    }
  };
  reader.readAsArrayBuffer(file);
}

/* ================= QOE - COM MELHORIA E STATUS ================= */
function colorByValue(v){
  if(!isFinite(v)) return '';
  if(v <= 40) return 'text-danger fw-bold';
  if(v <= 80) return 'text-warning fw-bold';
  return 'text-success fw-bold';
}

function renderQoe(){
  const arr = aggregateQoe(RAW, ['Node','Cluster','Cidade']);
  $('#tblQoeNode tbody').innerHTML = arr.map(r => {
    // Calcular melhoria e status
    const { melhoria, status } = calcularMelhoriaStatus(r.qoePre, r.qoePos, r.qoe24h);
    
    // Formatar melhoria com cor
    const melhoriaFormatada = fmtPct(melhoria);
    const melhoriaClass = melhoria > 0 ? 'text-success fw-bold' : 
                         melhoria < 0 ? 'text-danger fw-bold' : 'text-muted';
    
    // Formatar status com badge
    const statusBadge = status === 'Melhorando' ? 
      '<span class="badge bg-success">Melhorando</span>' :
      status === 'Piorando' ? 
      '<span class="badge bg-danger">Piorando</span>' :
      '<span class="badge bg-secondary">—</span>';
    
    return `<tr class="slide-in-up">
      <td>${r.Node}</td>
      <td>${r.Cluster}</td>
      <td>${r.Cidade}</td>
      <td class="text-end ${colorByValue(r.qoePre)}">${fmtNum(r.qoePre)}</td>
      <td class="text-end ${colorByValue(r.qoePos)}">${fmtNum(r.qoePos)}</td>
      <td class="text-end ${colorByValue(r.qoe24h)}">${fmtNum(r.qoe24h)}</td>
      <td class="text-end ${melhoriaClass}">${melhoriaFormatada}</td>
      <td>${statusBadge}</td>
    </tr>`;
  }).join('');
}

function aggregateQoe(rows,keys){
  const map=new Map();
  rows.forEach(r=>{
    const k=keys.map(k=>r[k]||'').join('||');
    const acc=map.get(k)||{cnt:0,qpre:0,qpos:0,q24h:0,Node:r.Node||'',Cluster:r.Cluster||'',Cidade:r.Cidade||''};
    acc.cnt++; 
    acc.qpre+=isFinite(r.QOE_Pre)?r.QOE_Pre:0; 
    acc.qpos+=isFinite(r.QOE_Pos)?r.QOE_Pos:0;
    acc.q24h+=isFinite(r.QOE_24h)?r.QOE_24h:0;
    map.set(k,acc);
  });
  return Array.from(map.values()).map(v=>{
    const pre=v.cnt?v.qpre/v.cnt:0;
    const pos=v.cnt?v.qpos/v.cnt:0;
    const q24h=v.cnt?v.q24h/v.cnt:0;
    return {...v,qoePre:pre,qoePos:pos,qoe24h:q24h};
  });
}

/* ================= Incidentes por Cluster ================= */
function renderCluster(){
  const grp={}; RAW.forEach(r=>{grp[r.Cluster]=(grp[r.Cluster]||0)+1});
  const arr=Object.entries(grp).map(([c,v])=>({c,v})).sort((a,b)=>b.v-a.v);
  
  const tbody = $('#tblCluster tbody');
  tbody.innerHTML = arr.map(({c,v}) => 
    `<tr class="cluster-row pointer slide-in-up" data-cluster="${c}">
      <td>${c}</td>
      <td class="text-end">${v}</td>
    </tr>`
  ).join('');
  
  const clusterRows = document.querySelectorAll('#tblCluster .cluster-row');
  clusterRows.forEach(row => {
    row.addEventListener('click', function() {
      const cluster = this.getAttribute('data-cluster');
      showCidadesPorCluster(cluster);
    });
  });
  
  if(selectedCluster) {
    clusterRows.forEach(row => {
      if(row.getAttribute('data-cluster') === selectedCluster) {
        row.classList.add('selected');
      }
    });
  }
  
  const colorPalette = [
    'rgba(255, 107, 107, 0.8)',
    'rgba(78, 205, 196, 0.8)',
    'rgba(69, 183, 209, 0.8)',
    'rgba(150, 206, 180, 0.8)',
    'rgba(249, 210, 118, 0.8)'
  ];
  
  const borderColorPalette = [
    'rgb(255, 107, 107)',
    'rgb(78, 205, 196)',
    'rgb(69, 183, 209)',
    'rgb(150, 206, 180)',
    'rgb(249, 210, 118)'
  ];
  
  upsertBar('chartCluster','Incidentes',arr.map(x=>x.c),arr.map(x=>x.v),{
    indexAxis:'y',
    colorPalette: colorPalette,
    borderColorPalette: borderColorPalette
  });
}

/* ================= Mostrar Cidades por Cluster ================= */
function showCidadesPorCluster(cluster) {
  selectedCluster = cluster;
  
  const filteredData = RAW.filter(r => r.Cluster === cluster);
  
  const grp = {};
  filteredData.forEach(r => { grp[r.Cidade] = (grp[r.Cidade] || 0) + 1 });
  const arr = Object.entries(grp).map(([c,v]) => ({c,v})).sort((a,b) => b.v - a.v);
  
  $('#tblCidade tbody').innerHTML = arr.map(({c,v}) => 
    `<tr class="slide-in-up">
      <td>${c}</td>
      <td class="text-end">${v}</td>
    </tr>`
  ).join('');
  
  const colorPalette = [
    'rgba(255, 107, 107, 0.8)',
    'rgba(78, 205, 196, 0.8)',
    'rgba(69, 183, 209, 0.8)',
    'rgba(150, 206, 180, 0.8)',
    'rgba(249, 210, 118, 0.8)'
  ];
  
  const borderColorPalette = [
    'rgb(255, 107, 107)',
    'rgb(78, 205, 196)',
    'rgb(69, 183, 209)',
    'rgb(150, 206, 180)',
    'rgb(249, 210, 118)'
  ];
  
  upsertBar('chartCidade','Incidentes',arr.map(x=>x.c),arr.map(x=>x.v),{
    indexAxis:'y',
    colorPalette: colorPalette,
    borderColorPalette: borderColorPalette
  });
  
  $('#tituloCidade').innerHTML = `Incidentes por Cidade<br><small class="text-muted">Cluster: <strong class="text-primary">${cluster}</strong></small>`;
  
  const clusterRows = document.querySelectorAll('#tblCluster .cluster-row');
  clusterRows.forEach(row => {
    row.classList.remove('selected');
    if (row.getAttribute('data-cluster') === cluster) {
      row.classList.add('selected');
    }
  });
  
  document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
  document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('show', 'active'));
  
  document.getElementById('tabCidadeBtn').classList.add('active');
  document.getElementById('tabCidade').classList.add('show', 'active');
  
  document.getElementById('btnVoltarCluster').style.display = 'inline-block';
}

/* ================= Tipo de Fechamento ================= */
function renderFechamento(){
  const grp={}; RAW.forEach(r=>{grp[r.Tipo_Fechamento]=(grp[r.Tipo_Fechamento]||0)+1});
  const total=Object.values(grp).reduce((a,b)=>a+b,0)||1;
  const arr=Object.entries(grp).map(([t,v])=>({t,v})).sort((a,b)=>b.v-a.v);
  $('#tblFechamento tbody').innerHTML=arr.map(e=>`<tr class="slide-in-up">
    <td>${e.t}</td><td class="text-end">${e.v}</td><td class="text-end">${(e.v/total*100).toFixed(1)}%</td>
  </tr>`).join('');
  
  const colorPalette = [
    'rgba(255, 107, 107, 0.8)',
    'rgba(78, 205, 196, 0.8)',
    'rgba(69, 183, 209, 0.8)',
    'rgba(150, 206, 180, 0.8)',
    'rgba(249, 210, 118, 0.8)'
  ];
  
  const borderColorPalette = [
    'rgb(255, 107, 107)',
    'rgb(78, 205, 196)',
    'rgb(69, 183, 209)',
    'rgb(150, 206, 180)',
    'rgb(249, 210, 118)'
  ];
  
  upsertPie('chartFechamento',arr.map(e=>e.t),arr.map(e=>e.v), {
    colorPalette: colorPalette,
    borderColorPalette: borderColorPalette
  });
}

/* ================= Reincidência ================= */
function renderReinc(){
  const byNode = groupBy(RAW, 'Node');
  const reinc = Object.entries(byNode)
    .filter(([_, list]) => list.length > 1)
    .map(([n, l]) => ({
      Node: n, 
      Cluster: l[0].Cluster, 
      Cidade: l[0].Cidade, 
      Count: l.length,
      Incidents: l.map(x => ({
        solucao: x.Tipo_Fechamento || '(sem solução)',
        data: x.Data ? formatarData(x.Data) : '(sem data)',
        qoePre: x.QOE_Pre || 0,
        qoePos: x.QOE_Pos || 0,
        cluster: x.Cluster || '',
        cidade: x.Cidade || '',
        incidente: x.INCIDENTE || ''
      }))
    })).sort((a, b) => b.Count - a.Count);

  const tbody = $('#tblReinc tbody'); 
  tbody.innerHTML = '';
  
  reinc.forEach((r, index) => {
    const tr = document.createElement('tr'); 
    tr.className = 'pointer slide-in-up';
    tr.style.animationDelay = `${index * 0.1}s`;
    tr.setAttribute('data-node', r.Node);
    tr.innerHTML = `
      <td>
        <div class="d-flex align-items-center">
          <i class="bi bi-chevron-right me-2 expand-icon" style="font-size: 0.8rem; transition: transform 0.3s ease;"></i>
          ${r.Node}
        </div>
      </td>
      <td>${r.Cluster}</td>
      <td>${r.Cidade}</td>
      <td class="text-center">
        <span class="badge bg-danger rounded-pill">${r.Count} ocorrências</span>
      </td>`;
    
    tr.addEventListener('click', (e) => {
      if (!e.target.classList.contains('expand-icon')) {
        toggleDetalhesNode(tr, r);
      }
    });
    
    const expandIcon = tr.querySelector('.expand-icon');
    expandIcon.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleDetalhesNode(tr, r);
    });
    
    tbody.appendChild(tr);
  });
}

/* ================= Toggle Detalhes ================= */
function toggleDetalhesNode(tr, nodeData){
  const expandIcon = tr.querySelector('.expand-icon');
  const nodeName = nodeData.Node;
  
  const existingDetails = $(`tr.details-row[data-node="${nodeName}"]`);
  
  if (existingDetails) {
    existingDetails.remove();
    expandIcon.classList.remove('bi-chevron-down');
    expandIcon.classList.add('bi-chevron-right');
    tr.classList.remove('table-active');
  } else {
    $$('#tblReinc .details-row').forEach(row => row.remove());
    $$('#tblReinc .expand-icon').forEach(icon => {
      icon.classList.remove('bi-chevron-down');
      icon.classList.add('bi-chevron-right');
    });
    $$('#tblReinc tr').forEach(row => row.classList.remove('table-active'));
    
    const detailsRow = document.createElement('tr');
    detailsRow.className = 'details-row slide-in-up';
    detailsRow.setAttribute('data-node', nodeName);
    
    detailsRow.innerHTML = `
      <td colspan="4" class="p-0 border-0">
        <div class="details-content bg-light p-4">
          <div class="row">
            <div class="col-12">
              <h6 class="text-primary mb-3">
                <i class="bi bi-list-ul me-2"></i>
                Detalhes dos Incidentes - ${nodeData.Node}
                <small class="text-muted ms-2">(${nodeData.Count} ocorrências)</small>
              </h6>
            </div>
          </div>
          <div class="row">
            ${nodeData.Incidents.map((inc, index) => `
              <div class="col-12 col-md-6 col-lg-4 mb-3">
                <div class="card border-0 shadow-sm h-100">
                  <div class="card-header bg-white py-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <span class="badge bg-primary">#${index + 1}</span>
                      <small class="text-muted">${inc.data}</small>
                    </div>
                    ${inc.incidente ? `<small class="text-muted d-block mt-1">Incidente: ${inc.incidente}</small>` : ''}
                  </div>
                  <div class="card-body p-3">
                    <div class="mb-2">
                      <strong class="text-dark">Solução:</strong>
                      <span class="ms-2">${inc.solucao}</span>
                    </div>
                    <div class="mb-2">
                      <strong class="text-dark">QOE:</strong>
                      <span class="ms-2">
                        <span class="${inc.qoePre > 80 ? 'text-success' : inc.qoePre > 60 ? 'text-warning' : 'text-danger'}">
                          ${inc.qoePre.toFixed(1)}
                        </span>
                        <i class="bi bi-arrow-right mx-1 text-muted"></i>
                        <span class="${inc.qoePos > 80 ? 'text-success' : inc.qoePos > 60 ? 'text-warning' : 'text-danger'}">
                          ${inc.qoePos.toFixed(1)}
                        </span>
                      </span>
                    </div>
                    <div class="mb-0">
                      <strong class="text-dark">Local:</strong>
                      <span class="ms-2">${inc.cidade} / ${inc.cluster}</span>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </td>
    `;
    
    tr.insertAdjacentElement('afterend', detailsRow);
    expandIcon.classList.remove('bi-chevron-right');
    expandIcon.classList.add('bi-chevron-down');
    tr.classList.add('table-active');
  }
}

/* ================= Dashboard ================= */
function renderResumo(){
  const byCluster=groupBy(RAW,'Cluster');
  const wrap=$('#cardsResumo'); wrap.innerHTML='';
  Object.entries(byCluster).forEach(([cl,rows], index) => {
    const total=rows.length;
    const nodes=groupBy(rows,'Node');
    const reinc=Object.values(nodes).filter(a=>a.length>1).length;
    const taxa=total?(reinc/Object.keys(nodes).length*100):0;

    const card=document.createElement('div'); 
    card.className='col-12 col-md-6 col-lg-4';
    card.style.animationDelay = `${index * 0.1}s`;
    card.innerHTML = `
      <div class="card-custom h-100 p-4">
        <div class="card-body p-0">
          <h5 class="mb-3 section-title">${cl}</h5>
          <div class="d-flex align-items-center mb-3">
            <div class="me-3">
              <i class="bi bi-exclamation-circle fs-4 text-primary"></i>
            </div>
            <div>
              <div class="text-muted small">Total de Incidentes</div>
              <div class="h4 mb-0 fw-bold">${total}</div>
            </div>
          </div>
          <div class="d-flex align-items-center">
            <div class="me-3">
              <i class="bi bi-clock-history fs-4 ${taxa>20?'text-danger':'text-info'}"></i>
            </div>
            <div>
              <div class="text-muted small">Taxa de Reincidência</div>
              <div class="h5 mb-0 ${taxa>20?'text-danger':'text-info'}">${taxa.toFixed(1)}%</div>
            </div>
          </div>
        </div>
      </div>`;
    wrap.appendChild(card);
  });
}

/* ================= Charts ================= */
function upsertBar(id,label,labels,data,extra){
  const ctx=document.getElementById(id);
  if(charts[id]) charts[id].destroy();
  
  const defaultColorPalette = [
    'rgba(255, 107, 107, 0.8)',
    'rgba(78, 205, 196, 0.8)',
    'rgba(69, 183, 209, 0.8)',
    'rgba(150, 206, 180, 0.8)',
    'rgba(249, 210, 118, 0.8)'
  ];
  
  const defaultBorderColorPalette = [
    'rgb(255, 107, 107)',
    'rgb(78, 205, 196)',
    'rgb(69, 183, 209)',
    'rgb(150, 206, 180)',
    'rgb(249, 210, 118)'
  ];
  
  const colorPalette = extra?.colorPalette || defaultColorPalette;
  const borderColorPalette = extra?.borderColorPalette || defaultBorderColorPalette;
  
  charts[id]=new Chart(ctx,{
    type:'bar',
    data:{ 
      labels, 
      datasets:[{ 
        label, 
        data,
        backgroundColor: data.map((_, index) => colorPalette[index % colorPalette.length]),
        borderColor: data.map((_, index) => borderColorPalette[index % borderColorPalette.length]),
        borderWidth: 2,
        borderRadius: 6,
        borderSkipped: false,
      }] 
    },
    options:Object.assign({ 
      responsive: true, 
      maintainAspectRatio: true,
      plugins:{ 
        legend:{ 
          display: false 
        },
        tooltip: {
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          titleColor: '#1a1a1a',
          bodyColor: '#5a5a5a',
          borderColor: 'rgba(0, 0, 0, 0.1)',
          borderWidth: 1,
          cornerRadius: 8,
          displayColors: true,
        }
      },
      animation: {
        duration: 1500,
        easing: 'easeOutQuart'
      },
      scales: {
        x: {
          grid: {
            color: 'rgba(0,0,0,0.05)',
            drawBorder: false,
          },
          ticks: {
            color: 'rgba(0,0,0,0.6)',
          }
        },
        y: {
          grid: {
            color: 'rgba(0,0,0,0.05)',
            drawBorder: false,
          },
          ticks: {
            color: 'rgba(0,0,0,0.6)',
          }
        }
      }
    }, extra||{})
  });
}

function upsertPie(id,labels,data,extra){
  const ctx=document.getElementById(id);
  if(charts[id]) charts[id].destroy();
  
  const defaultColorPalette = [
    'rgba(255, 107, 107, 0.8)',
    'rgba(78, 205, 196, 0.8)',
    'rgba(69, 183, 209, 0.8)',
    'rgba(150, 206, 180, 0.8)',
    'rgba(249, 210, 118, 0.8)'
  ];
  
  const defaultBorderColorPalette = [
    'rgb(255, 107, 107)',
    'rgb(78, 205, 196)',
    'rgb(69, 183, 209)',
    'rgb(150, 206, 180)',
    'rgb(249, 210, 118)'
  ];
  
  const colorPalette = extra?.colorPalette || defaultColorPalette;
  const borderColorPalette = extra?.borderColorPalette || defaultBorderColorPalette;
  
  charts[id]=new Chart(ctx,{ 
    type:'pie', 
    data:{ 
      labels, 
      datasets:[{ 
        data,
        backgroundColor: data.map((_, index) => colorPalette[index % colorPalette.length]),
        borderColor: borderColorPalette.map(color => color),
        borderWidth: 3,
        hoverOffset: 15
      }] 
    }, 
    options:{ 
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          titleColor: '#1a1a1a',
          bodyColor: '#5a5a5a',
          borderColor: 'rgba(0, 0, 0, 0.1)',
          borderWidth: 1,
          cornerRadius: 8,
          displayColors: true,
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = Math.round((value / total) * 100);
              return `${label}: ${value} (${percentage}%)`;
            }
          }
        }
      },
      animation: {
        duration: 1500,
        easing: 'easeOutQuart',
        animateRotate: true,
        animateScale: true
      },
      cutout: '0%'
    } 
  });
}

/* ================= Utils ================= */
function groupBy(a,k){ 
  return a.reduce((acc, current) => {
    const groupKey = current[k] || '(não informado)';
    if (!acc[groupKey]) {
      acc[groupKey] = [];
    }
    acc[groupKey].push(current);
    return acc;
  }, {});
}

function formatarData(data) {
  if (!data || !(data instanceof Date) || isNaN(data.getTime())) {
    return '(sem data)';
  }
  
  try {
    return data.toLocaleString('pt-BR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    return '(erro na data)';
  }
}

/* ================= UI Helpers ================= */
function showLoading() {
  hideLoading();
  
  const overlay = document.createElement('div');
  overlay.className = 'loading-overlay';
  overlay.id = 'loadingOverlay';
  overlay.innerHTML = `
    <div class="text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p class="mt-2 text-muted">Processando dados...</p>
    </div>
  `;
  
  document.querySelector('main').appendChild(overlay);
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.remove();
  }
}

function showToast(message, type = 'info') {
  const existingToasts = document.querySelectorAll('.toast-container');
  existingToasts.forEach(toast => toast.remove());
  
  const toastContainer = document.createElement('div');
  toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
  
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white bg-${type} border-0`;
  toast.setAttribute('role', 'alert');
  toast.setAttribute('aria-live', 'assertive');
  toast.setAttribute('aria-atomic', 'true');
  
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        ${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  `;
  
  toastContainer.appendChild(toast);
  document.body.appendChild(toastContainer);
  
  const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
  bsToast.show();
}

/* ================= Render inicial ================= */
function renderAll(){ 
  renderCluster(); 
  renderQoe(); 
  renderFechamento(); 
  renderReinc(); 
  renderResumo(); 
}

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('btnVoltarCluster').style.display = 'none';
  
  document.getElementById('btnVoltarCluster').addEventListener('click', function() {
    selectedCluster = null;
    
    document.querySelectorAll('#tblCluster .cluster-row').forEach(row => {
      row.classList.remove('selected');
    });
    
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('show', 'active'));
    
    document.getElementById('tabClusterBtn').classList.add('active');
    document.getElementById('tabCluster').classList.add('show', 'active');
    
    this.style.display = 'none';
  });
  
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', function() {
      if(this.id !== 'tabCidadeBtn') {
        document.getElementById('btnVoltarCluster').style.display = 'none';
      } else if(selectedCluster) {
        document.getElementById('btnVoltarCluster').style.display = 'inline-block';
      }
    });
  });
});
</script>
</body>
</html>
