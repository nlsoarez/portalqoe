<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Análise de Volumetria</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --text-color: #333;
      --text-light: #7f8c8d;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      color: var(--text-color);
      background-color: #f5f7fa;
      line-height: 1.6;
      padding: 0;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 20px 0;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      font-size: 24px;
      font-weight: 500;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .logo i {
      font-size: 28px;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      padding: 20px;
      margin-bottom: 20px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 15px;
      color: var(--primary-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .file-input-container {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .file-input-wrapper {
      position: relative;
      flex-grow: 1;
    }
    
    .file-input-label {
      display: block;
      padding: 10px 15px;
      background-color: var(--secondary-color);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.3s;
    }
    
    .file-input-label:hover {
      background-color: #2980b9;
    }
    
    #fileInput {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .btn {
      padding: 10px 20px;
      background-color: var(--success-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      background-color: #219653;
    }
    
    .btn-secondary {
      background-color: var(--light-color);
      color: var(--text-color);
    }
    
    .btn-secondary:hover {
      background-color: #d5dbdb;
    }
    
    .filters-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark-color);
    }
    
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      font-family: inherit;
    }
    
    .view-options {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .view-btn {
      padding: 8px 15px;
      background-color: var(--light-color);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }
    
    .view-btn.active {
      background-color: var(--secondary-color);
      color: white;
    }
    
    .chart-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .chart-wrapper {
      position: relative;
      height: 400px;
    }
    
    .tables-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    th {
      background-color: var(--primary-color);
      color: white;
      padding: 12px;
      text-align: left;
    }
    
    td {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    tr:hover {
      background-color: #e9f7fe;
    }
    
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .summary-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      text-align: center;
    }
    
    .summary-card h3 {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 10px;
    }
    
    .summary-card .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .loading.active {
      display: flex;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--secondary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .data-info {
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 20px;
    }
    
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 4px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1100;
      transform: translateX(0);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    
    .alert-success {
      background-color: var(--success-color);
    }
    
    .alert-warning {
      background-color: var(--warning-color);
    }
    
    .alert-error {
      background-color: var(--accent-color);
    }
    
    .alert.fade-out {
      transform: translateX(100%);
      opacity: 0;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      margin-left: 15px;
    }
    
    @media (max-width: 768px) {
      .chart-container {
        grid-template-columns: 1fr;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .filters-container {
        flex-direction: column;
      }
      
      .file-input-container {
        flex-direction: column;
      }
    }
    
    @media (max-width: 576px) {
      .chart-container, .tables-container {
        grid-template-columns: 1fr;
      }
      
      .summary-cards {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <div class="logo">
        <i class="fas fa-chart-bar"></i>
        <h1>Dashboard de Análise de Volumetria</h1>
      </div>
      <div class="header-actions">
        <button id="exportBtn" class="btn btn-secondary">
          <i class="fas fa-download"></i> Exportar
        </button>
      </div>
    </div>
  </header>
  
  <div class="container">
    <div class="card">
      <div class="card-title">Carregar Dados</div>
      <div class="file-input-container">
        <div class="file-input-wrapper">
          <label for="fileInput" class="file-input-label">
            <i class="fas fa-file-excel"></i> Selecionar Arquivos Excel
          </label>
          <input type="file" id="fileInput" multiple accept=".xlsx, .xls">
        </div>
        <button class="btn" onclick="loadFiles()">
          <i class="fas fa-cogs"></i> Processar Dados
        </button>
      </div>
    </div>
    
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Processando dados...</p>
    </div>
    
    <div id="analysisSection" style="display: none;">
      <div class="card">
        <div class="card-title">Filtros de Análise</div>
        <div class="filters-container">
          <div class="filter-group">
            <label for="monthFilter"><i class="fas fa-calendar-alt"></i> Mês</label>
            <select id="monthFilter" onchange="applyFilters()">
              <option value="">Todos os meses</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="clusterFilter"><i class="fas fa-layer-group"></i> Cluster</label>
            <select id="clusterFilter" onchange="applyFilters()">
              <option value="">Todos os clusters</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="tipoFilter"><i class="fas fa-tag"></i> Tipo</label>
            <select id="tipoFilter" onchange="applyFilters()">
              <option value="">Todos os tipos</option>
            </select>
          </div>
        </div>
        
        <div class="view-options">
          <button class="view-btn active" onclick="changeView('unified')">
            <i class="fas fa-globe"></i> Visão Unificada
          </button>
          <button class="view-btn" onclick="changeView('monthly')">
            <i class="fas fa-calendar"></i> Visão por Mês
          </button>
        </div>
      </div>
      
      <div class="summary-cards">
        <div class="summary-card">
          <h3><i class="fas fa-database"></i> Total de Registros</h3>
          <div class="value" id="totalRecords">0</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-calendar-start"></i> Período Inicial</h3>
          <div class="value" id="startDate">-</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-calendar-end"></i> Período Final</h3>
          <div class="value" id="endDate">-</div>
        </div>
        <div class="summary-card">
          <h3><i class="fas fa-calendar-alt"></i> Meses Analisados</h3>
          <div class="value" id="monthsCount">0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title"><i class="fas fa-clock"></i> Distribuição por Hora do Dia</div>
        <div class="chart-container">
          <div class="chart-wrapper">
            <canvas id="horaChart"></canvas>
          </div>
          <div class="chart-wrapper">
            <canvas id="horaHeatmap"></canvas>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title"><i class="fas fa-calendar-week"></i> Distribuição por Dia da Semana</div>
        <div class="chart-container">
          <div class="chart-wrapper">
            <canvas id="diaSemanaChart"></canvas>
          </div>
          <div class="chart-wrapper">
            <canvas id="diaMesChart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title"><i class="fas fa-chart-pie"></i> Análise por Categoria</div>
        <div class="chart-container">
          <div class="chart-wrapper">
            <canvas id="clusterChart"></canvas>
          </div>
          <div class="chart-wrapper">
            <canvas id="tipoChart"></canvas>
          </div>
          <div class="chart-wrapper">
            <canvas id="tipoRalChart"></canvas>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title"><i class="fas fa-table"></i> Tabelas Detalhadas</div>
        <div id="output" class="tables-container"></div>
      </div>
    </div>
  </div>

  <script>
    // Continua na Parte 2...    let originalData = [];
    let charts = {};
    let currentView = 'unified';
    const diasSemana = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
    const mesesAno = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'flex' : 'none';
    }

    function showAlert(message, type) {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `
        <span>${message}</span>
        <button class="close-btn">&times;</button>
      `;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.classList.add('fade-out');
        setTimeout(() => alertDiv.remove(), 500);
      }, 5000);
      
      alertDiv.querySelector('.close-btn').addEventListener('click', () => {
        alertDiv.remove();
      });
    }

    function loadFiles() {
      const files = document.getElementById('fileInput').files;
      if (!files.length) {
        showAlert('Por favor, selecione pelo menos um arquivo Excel', 'warning');
        return;
      }
      
      showLoading(true);
      
      const promises = Array.from(files).map(file => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array', cellDates: true });
              const sheet = workbook.Sheets[workbook.SheetNames[0]];
              const json = XLSX.utils.sheet_to_json(sheet, { defval: "", raw: false, dateNF: 'dd/mm/yyyy hh:mm' });
              
              const processedData = json.map(row => {
                if (row["DIA/HORA"]) {
                  let date;
                  if (row["DIA/HORA"] instanceof Date) {
                    date = row["DIA/HORA"];
                  } else {
                    const dateStr = row["DIA/HORA"].toString().trim();
                    const brMatch = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})/);
                    if (brMatch) {
                      date = new Date(brMatch[3], brMatch[2]-1, brMatch[1], brMatch[4], brMatch[5]);
                    } else {
                      date = new Date(dateStr);
                    }
                  }
                  
                  if (!isNaN(date.getTime())) {
                    row._date = date;
                  }
                }
                return row;
              }).filter(row => row._date);
              
              resolve(processedData);
            } catch (error) {
              reject(`Erro ao processar o arquivo ${file.name}: ${error.message}`);
            }
          };
          reader.onerror = () => reject(`Erro ao ler o arquivo ${file.name}`);
          reader.readAsArrayBuffer(file);
        });
      });

      Promise.all(promises)
        .then(results => {
          originalData = [].concat(...results);
          
          if (originalData.length === 0) {
            showAlert('Nenhum dado válido encontrado nos arquivos selecionados', 'warning');
            showLoading(false);
            return;
          }
          
          updateDataInfo();
          updateFilterOptions(originalData);
          applyFilters();
          document.getElementById('analysisSection').style.display = 'block';
          showLoading(false);
          showAlert('Dados carregados com sucesso!', 'success');
        })
        .catch(error => {
          showAlert(error, 'error');
          console.error(error);
          showLoading(false);
        });
    }

    function updateDataInfo() {
      const dates = originalData.map(row => row._date).filter(d => !isNaN(d));
      const minDate = new Date(Math.min(...dates));
      const maxDate = new Date(Math.max(...dates));
      
      document.getElementById('dataInfo').textContent = 
        `Dados carregados: ${originalData.length.toLocaleString()} registros | ` +
        `Período: ${formatDate(minDate)} a ${formatDate(maxDate)}`;
      
      document.getElementById('totalRecords').textContent = originalData.length.toLocaleString();
      document.getElementById('startDate').textContent = formatDate(minDate, true);
      document.getElementById('endDate').textContent = formatDate(maxDate, true);
      
      const months = new Set();
      originalData.forEach(row => {
        const date = row._date;
        months.add(`${date.getFullYear()}-${date.getMonth()}`);
      });
      document.getElementById('monthsCount').textContent = months.size;
    }

    function formatDate(date, short = false) {
      if (short) {
        return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth()+1).padStart(2, '0')}/${date.getFullYear()}`;
      }
      return date.toLocaleDateString('pt-BR', { 
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function updateFilterOptions(data) {
      const monthSet = new Set();
      const clusterSet = new Set();
      const tipoSet = new Set();

      data.forEach(row => {
        try {
          const date = row._date;
          if (!isNaN(date)) {
            const month = `${String(date.getMonth()+1).padStart(2, '0')}/${date.getFullYear()}`;
            monthSet.add(month);
          }
          
          if (row["CLUSTER"]) clusterSet.add(row["CLUSTER"]);
          if (row["TIPO"]) tipoSet.add(row["TIPO"]);
        } catch (e) {
          console.warn('Erro ao processar linha:', row, e);
        }
      });

      updateSelectOptions('monthFilter', [...monthSet].sort(), "Todos os meses");
      updateSelectOptions('clusterFilter', [...clusterSet].sort(), "Todos os clusters");
      updateSelectOptions('tipoFilter', [...tipoSet].sort(), "Todos os tipos");
    }

    function updateSelectOptions(selectId, options, defaultText) {
      const select = document.getElementById(selectId);
      select.innerHTML = `<option value="">${defaultText}</option>`;
      options.forEach(opt => {
        select.innerHTML += `<option value="${opt}">${opt}</option>`;
      });
    }

    function changeView(view) {
      currentView = view;
      
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(view === 'unified' ? 'Unificada' : 'Mês'));
      });
      
      applyFilters();
    }

    function getFilteredData() {
      const selectedMonth = document.getElementById('monthFilter').value;
      const selectedCluster = document.getElementById('clusterFilter').value;
      const selectedTipo = document.getElementById('tipoFilter').value;

      return originalData.filter(row => {
        const date = row._date;
        const month = `${String(date.getMonth()+1).padStart(2, '0')}/${date.getFullYear()}`;
        const cluster = row["CLUSTER"] || "";
        const tipo = row["TIPO"] || "";
        
        return (!selectedMonth || month === selectedMonth) &&
               (!selectedCluster || cluster === selectedCluster) &&
               (!selectedTipo || tipo === selectedTipo);
      });
    }

    function applyFilters() {
      const filtered = getFilteredData();

      if (filtered.length === 0) {
        showAlert('Nenhum dado encontrado com os filtros selecionados', 'warning');
        return;
      }

      analyzeData(filtered);
    }

    function analyzeData(data) {
      clearCharts();
      document.getElementById("output").innerHTML = "";

      const counts = {
        cluster: {},
        tipo: {},
        tipoRal: {},
        hora: Array(24).fill(0),
        diaSemana: Array(7).fill(0),
        diaMes: Array(31).fill(0)
      };

      data.forEach(row => {
        try {
          const date = row._date;
          
          if (row["CLUSTER"]) counts.cluster[row["CLUSTER"]] = (counts.cluster[row["CLUSTER"]] || 0) + 1;
          if (row["TIPO"]) counts.tipo[row["TIPO"]] = (counts.tipo[row["TIPO"]] || 0) + 1;
          if (row["TIPO_RAL"]) counts.tipoRal[row["TIPO_RAL"]] = (counts.tipoRal[row["TIPO_RAL"]] || 0) + 1;
          
          if (!isNaN(date)) {
            const hour = date.getHours();
            const dayOfWeek = date.getDay();
            const dayOfMonth = date.getDate() - 1;
            
            counts.hora[hour]++;
            counts.diaSemana[dayOfWeek]++;
            if (dayOfMonth >= 0 && dayOfMonth < 31) counts.diaMes[dayOfMonth]++;
          }
        } catch (e) {
          console.warn('Erro ao analisar linha:', row, e);
        }
      });

      displayTable("Volume por Cluster", counts.cluster);
      displayTable("Volume por Tipo", counts.tipo);
      displayTable("Volume por Tipo de RAL", counts.tipoRal);
      displayTable("Distribuição por Hora", Object.fromEntries(counts.hora.map((v, i) => [i + 'h', v])));
      displayTable("Distribuição por Dia da Semana", Object.fromEntries(counts.diaSemana.map((v, i) => [diasSemana[i], v])));
      displayTable("Distribuição por Dia do Mês", Object.fromEntries(counts.diaMes.map((v, i) => [i + 1, v])));

      createChart("clusterChart", "Volume por Cluster", counts.cluster, 'bar');
      createChart("tipoChart", "Volume por Tipo", counts.tipo, 'pie');
      createChart("tipoRalChart", "Volume por Tipo de RAL", counts.tipoRal, 'doughnut');
      createChart("horaChart", "Volume por Hora do Dia", Object.fromEntries(counts.hora.map((v, i) => [i + 'h', v])), 'bar');
      createChart("diaSemanaChart", "Volume por Dia da Semana", Object.fromEntries(counts.diaSemana.map((v, i) => [diasSemana[i], v])), 'bar');
      createChart("diaMesChart", "Volume por Dia do Mês", Object.fromEntries(counts.diaMes.map((v, i) => [(i + 1).toString(), v])), 'bar');
      
      createHourHeatmap(counts.hora);
    }

    function displayTable(title, dataObj) {
      const output = document.getElementById("output");
      const sorted = Object.entries(dataObj).sort((a, b) => b[1] - a[1]);
      const total = sorted.reduce((sum, [_, val]) => sum + val, 0);
      
      let html = `
        <div class="card">
          <div class="card-title">${title}</div>
          <table>
            <thead>
              <tr>
                <th>Categoria</th>
                <th>Volume</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      sorted.forEach(([key, val]) => {
        const percentage = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
        html += `
          <tr>
            <td>${key}</td>
            <td>${val.toLocaleString()}</td>
            <td>${percentage}%</td>
          </tr>
        `;
      });
      
      html += `
            <tfoot>
              <tr>
                <td><strong>Total</strong></td>
                <td><strong>${total.toLocaleString()}</strong></td>
                <td><strong>100%</strong></td>
              </tr>
            </tfoot>
          </tbody>
        </table>
      </div>
      `;
      
      output.innerHTML += html;
    }

    function createChart(canvasId, label, dataObj, type) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      let labels = Object.keys(dataObj);
      let data = Object.values(dataObj);
      
      if (type === 'bar' && !canvasId.includes('hora') && !canvasId.includes('dia')) {
        const combined = labels.map((label, i) => ({label, value: data[i]}));
        combined.sort((a, b) => b.value - a.value);
        labels = combined.map(item => item.label);
        data = combined.map(item => item.value);
      }
      
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }

      charts[canvasId] = new Chart(ctx, {
        type,
        data: {
          labels,
          datasets: [{
            label,
            data,
            backgroundColor: getChartColors(labels.length, type),
            borderColor: type === 'bar' ? 'rgba(75, 192, 192, 0.2)' : undefined,
            borderWidth: type === 'bar' ? 1 : 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: type !== 'bar',
              position: 'right'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            },
            title: {
              display: true,
              text: label,
              font: {
                size: 16
              }
            }
          },
          scales: type === 'bar' ? {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Quantidade'
              }
            },
            x: {
              title: {
                display: true,
                text: getXAxisLabel(canvasId)
              }
            }
          } : {}
        }
      });
    }

    function getXAxisLabel(canvasId) {
      if (canvasId.includes('hora')) return 'Hora do dia';
      if (canvasId.includes('diaSemana')) return 'Dia da semana';
      if (canvasId.includes('diaMes')) return 'Dia do mês';
      return 'Categoria';
    }

    function getChartColors(count, type) {
      if (type === 'bar') {
        const colors = [];
        for (let i = 0; i < count; i++) {
          const hue = 200 + (i * 30) % 160;
          colors.push(`hsl(${hue}, 70%, 50%)`);
        }
        return colors;
      }
      
      const baseColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
        '#9966FF', '#FF9F40', '#8AC24A', '#607D8B',
        '#E91E63', '#3F51B5', '#009688', '#795548',
        '#9C27B0', '#2196F3', '#00BCD4', '#CDDC39'
      ];
      
      const colors = [];
      for (let i = 0; i < count; i++) {
        colors.push(baseColors[i % baseColors.length]);
      }
      return colors;
    }

    function createHourHeatmap(hourData) {
      const ctx = document.getElementById('horaHeatmap').getContext('2d');
      
      if (charts['horaHeatmap']) {
        charts['horaHeatmap'].destroy();
      }
      
      const maxValue = Math.max(...hourData);
      const data = {
        labels: ['00h', '', '', '', '04h', '', '', '', '08h', '', '', '', '12h', '', '', '', '16h', '', '', '', '20h', '', '', ''],
        datasets: [{
          data: hourData,
          backgroundColor: hourData.map(value => {
            const intensity = maxValue > 0 ? value / maxValue : 0;
            return `rgba(52, 152, 219, ${0.3 + intensity * 0.7})`;
          }),
          borderColor: hourData.map(() => 'rgba(255, 255, 255, 0.2)'),
          borderWidth: 1
        }]
      };
      
      charts['horaHeatmap'] = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Volume: ${context.raw}`;
                }
              }
            },
            title: {
              display: true,
              text: 'Heatmap de Volume por Hora',
              font: {
                size: 16
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Quantidade'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Hora do dia'
              }
            }
          }
        }
      });
    }

    function clearCharts() {
      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};
    }

    function exportData() {
      if (!originalData.length) {
        showAlert('Nenhum dado disponível para exportação', 'warning');
        return;
      }

      const filteredData = getFilteredData();
      const ws = XLSX.utils.json_to_sheet(filteredData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "DadosFiltrados");
      
      const date = new Date().toISOString().slice(0, 10);
      XLSX.writeFile(wb, `volumetria_${date}.xlsx`);
    }

    document.getElementById('exportBtn').addEventListener('click', exportData);
  </script>
</body>
</html>
