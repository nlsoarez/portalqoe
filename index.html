<!-- ==========================
     PORTAL DE ANÁLISE DE INCIDENTES
     PARTE 1/2 - Estrutura HTML + Estilos + Layout
========================== -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal de Análise de Incidentes</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- pdfmake -->
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/pdfmake.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.10/build/vfs_fonts.js"></script>
  <style>
    :root {
      --claro-red: #e30613;
      --claro-dark: #1a1a1a;
      --claro-green: #29a329;
      --claro-yellow: #e3a81e;
      --claro-blue: #0066cc;
      --claro-danger: #d62828;
      --bg-soft: #f7f7f7;
    }
    body { background: var(--bg-soft); }
    .app-header { background: var(--claro-dark); color: #fff; }
    .brand-dot { width: .75rem; height: .75rem; border-radius: 50%; background: var(--claro-red); display: inline-block; margin-right:.5rem }
    .sidebar { min-height: 100vh; background: #fff; border-right: 1px solid #e9ecef; }
    .sidebar .nav-link { color: #333; border-radius: .5rem; }
    .sidebar .nav-link.active { background: var(--claro-red); color:#fff; }
    .card { border: none; box-shadow: 0 6px 24px rgba(0,0,0,.06); }
    .card-header { background: #fff; border-bottom: 1px solid #efefef; }
    .badge-green { background: var(--claro-green)!important; }
    .badge-yellow { background: var(--claro-yellow)!important; }
    .badge-red { background: var(--claro-danger)!important; }
    .kpi { font-weight: 700; font-size: 1.3rem; }
    .table thead th { white-space: nowrap; }
    .table-sticky thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
    .upload-drop {
      border: 2px dashed var(--claro-blue);
      border-radius: .75rem;
      background: #fff;
      padding: 1.25rem;
      text-align: center;
      transition: background .2s, border-color .2s;
    }
    .upload-drop.dragover { background: #eef6ff; border-color: var(--claro-red); }
    .small-note { font-size: .85rem; color:#666 }
    .pointer { cursor: pointer; }
    .legend-dot { width: 12px; height: 12px; border-radius:50%; display:inline-block; margin-right: .35rem; }
    .chart-wrap { position: relative; height: 340px; }
  </style>
</head>
<body>
  <header class="app-header py-3">
    <div class="container-fluid">
      <div class="d-flex align-items-center justify-content-between">
        <h1 class="h4 m-0"><span class="brand-dot"></span>Portal de Análise de Incidentes</h1>
        <div class="d-flex gap-2">
          <div class="text-end">
            <small class="d-block">Envie a planilha (.xlsx, .xls, .csv)</small>
            <input id="inputFile" type="file" class="form-control form-control-sm" accept=".xlsx,.xls,.csv" />
          </div>
          <button id="btnDemo" class="btn btn-outline-light btn-sm" data-bs-toggle="tooltip" data-bs-title="Carrega uma amostra interna para testar a interface."><i class="bi bi-magic"></i> Demo</button>
        </div>
      </div>
    </div>
  </header>

  <!--
    ========================
    AQUI FICA TODA A ESTRUTURA DE LAYOUT, SIDEBAR, TABS, TABELAS E GRÁFICOS
    ========================
    (Conteúdo igual ao da versão original, mantido na PARTE 1)
  -->

<!-- ==========================
     PORTAL DE ANÁLISE DE INCIDENTES
     PARTE 2/2 - Scripts e Lógica JS
========================== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// =========================
// Utilidades
// =========================
const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
const $ = (sel, ctx=document) => ctx.querySelector(sel);
let RAW = [];
let DATA_ALL = [];
let charts = {};

// Colunas esperadas
const EXPECTED = {
  Cluster: 'Cluster', Node: 'Node', Cidade: 'Cidade',
  Data: 'Data', Tipo_Incidente: 'Tipo_Incidente', Tipo_Fechamento: 'Tipo_Fechamento',
  QOE_Pre: 'QOE_Pre', QOE_Pos: 'QOE_Pos', Status_Reincidencia: 'Status_Reincidencia'
};

// Mapeamentos automáticos (inclui acentos e parênteses)
const AUTO_MAP = {
  'CLUSTER':'Cluster','CIDADE':'Cidade','NODE':'Node',
  'HI_INICIO':'Data','HI_(DATA_E_HORA_INICIO)':'Data','HI_DATA_E_HORA_INICIO':'Data',
  'HF_(DATA_E_HORA_FIM)':'Data_Fim','HF_DATA_E_HORA_FIM':'Data_Fim',
  'INCIDENTE':'Tipo_Incidente','SOLUCAO':'Tipo_Fechamento','SOLUÇÃO':'Tipo_Fechamento','TIPO_FECHAMENTO':'Tipo_Fechamento',
  'QOE_PRE':'QOE_Pre','QOE_PRÉ':'QOE_Pre','QOE_POS':'QOE_Pos','QOE_PÓS':'QOE_Pos',
  'OBSERVACAO':'Observacao','OBSERVAÇÃO':'Observacao','OUTAGE_MDU':'Outage_MDU','OUTAGE_DE_MDU_VINCULADO':'Outage_MDU',
  'RET':'RET'
};

// Tooltips
const enableTooltips = () => $$('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
document.addEventListener('DOMContentLoaded', enableTooltips);

// Upload Drag & Drop
const dropArea = $('#dropArea');
const inputFile = $('#inputFile');
;['dragenter','dragover'].forEach(evt=>dropArea.addEventListener(evt,e=>{e.preventDefault();dropArea.classList.add('dragover');}))
;['dragleave','drop'].forEach(evt=>dropArea.addEventListener(evt,e=>{e.preventDefault();dropArea.classList.remove('dragover');}))
dropArea.addEventListener('drop', e=>{const file=e.dataTransfer.files?.[0];if(file) handleFile(file);});
inputFile.addEventListener('change', e=>{const file=e.target.files?.[0];if(file) handleFile(file);});

// Demo
$('#btnDemo').addEventListener('click',()=>{const demo=makeDemoData();DATA_ALL=demo;RAW=[...DATA_ALL];afterLoad();});

// =========================
// Leitura Planilha (SheetJS)
// =========================
function handleFile(file){
  if(!/(xlsx|xls|csv)$/i.test(file.name)) return alert('Formato inválido');
  const reader=new FileReader();
  reader.onload=e=>{
    const data=new Uint8Array(e.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const wsname=wb.SheetNames[0];
    const ws=wb.Sheets[wsname];
    let json=XLSX.utils.sheet_to_json(ws,{defval:'',raw:false});
    json=normalizeColumns(json);
    const {rows,errors}=validateAndFix(json);
    if(errors.length) alert('Aviso de validação:\n'+errors.join('\n'));
    DATA_ALL=rows;RAW=[...DATA_ALL];afterLoad();
  };
  reader.readAsArrayBuffer(file);
}

function normalizeColumns(rows){
  if(!rows.length) return [];
  const keys=Object.keys(rows[0]);
  const badKeys=keys.filter(k=>/^(Unnamed|\.{3}\d+)/i.test(k));
  const values0=Object.values(rows[0]).map(v=>String(v||'').trim().toUpperCase());
  const looksLikeHeader=['INCIDENTE','CIDADE','CLUSTER','NODE','QOE','SOLU','OBSERV'].some(h=>values0.some(v=>v.includes(h)));
  if(badKeys.length/Math.max(1,keys.length)>0.3 && looksLikeHeader){
    const newHeader=Object.values(rows[0]).map(v=>String(v||'').trim());
    const dataRows=rows.slice(1);
    rows=dataRows.map(r=>{const o={};newHeader.forEach((h,i)=>{const k=keys[i];o[h||`COL_${i}`]=r[k];});return o;});
  }
  const map={};
  Object.keys(rows[0]).forEach(c=>{
    const k=c.trim().normalize('NFD').replace(/\p{Diacritic}/gu,'').toUpperCase().replace(/\s+/g,'_').replace(/[()]/g,'');
    map[c]=AUTO_MAP[k]||AUTO_MAP[c]||c;
  });
  return rows.map(r=>{
    const o={};Object.entries(r).forEach(([k,v])=>o[map[k]]=v);
    if(o['Data']&&!isFinite(Date.parse(o['Data'])))o['Data']=parseDateSmart(o['Data']);
    return o;
  });
}

function validateAndFix(rows){
  const errors=[];const out=rows.map(r=>({...r}));
  const missing=Object.values(EXPECTED).filter(k=>!rows.some(r=>k in r));
  if(missing.length) missing.forEach(m=>errors.push(`Coluna esperada ausente: ${m}`));
  out.forEach(r=>{
    r.Data=r.Data?new Date(r.Data):null;
    r.QOE_Pre=r.QOE_Pre!==undefined&&r.QOE_Pre!==''?Number(r.QOE_Pre):null;
    r.QOE_Pos=r.QOE_Pos!==undefined&&r.QOE_Pos!==''?Number(r.QOE_Pos):null;
    r.Status_Reincidencia=r.Status_Reincidencia||'';
    ['Cluster','Node','Cidade','Tipo_Incidente','Tipo_Fechamento'].forEach(k=>{if(r[k]===undefined)r[k]='';r[k]=String(r[k]).trim();});
  });
  return{rows:out,errors};
}

function parseDateSmart(s){
  if(!s)return'';
  const m1=s.match(/(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?/);
  if(m1){const[_,d,mo,y,h='00',mi='00',se='00']=m1;return new Date(`${y}-${mo}-${d}T${h}:${mi}:${se}`)}
  const t=Date.parse(s);return isFinite(t)?new Date(t):'';
}

// =========================
// Filtros e Renderizações
// =========================
$('#btnAplicarFiltros').addEventListener('click', applyFilters);
$('#btnLimparFiltros').addEventListener('click',()=>{
  $('#filterCluster').value='';$('#filterDataIni').value='';$('#filterDataFim').value='';applyFilters();
});

function afterLoad(){
  const clusters=Array.from(new Set(DATA_ALL.map(r=>r.Cluster).filter(Boolean))).sort();
  $('#filterCluster').innerHTML='<option value="">Todos</option>'+clusters.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
  applyFilters();
}

function applyFilters(){
  const c=$('#filterCluster').value;
  const di=$('#filterDataIni').value?new Date($('#filterDataIni').value):null;
  const df=$('#filterDataFim').value?new Date($('#filterDataFim').value):null;
  RAW=DATA_ALL.filter(r=>{
    let ok=true;
    if(c)ok=ok&&r.Cluster===c;
    if(di)ok=ok&&r.Data&&r.Data>=di;
    if(df){const dfEnd=new Date(df);dfEnd.setHours(23,59,59,999);ok=ok&&r.Data&&r.Data<=dfEnd;}
    return ok;
  });
  const byNode=groupBy(RAW,'Node');
  RAW.forEach(r=>{const count=(byNode[r.Node]||[]).length;r.Status_Reincidencia=count>1?'Reincidente':'Único';});
  renderAll();
}

// =========================
// Funções auxiliares
// =========================
function groupBy(arr,key){return arr.reduce((a,c)=>{const k=c[key]||'';(a[k]||(a[k]=[])).push(c);return a;},{});}
function countBy(arr,key){return arr.reduce((a,c)=>{const k=c[key]||'';a[k]=(a[k]||0)+1;return a;},{});}
function fmtPct(n){return isFinite(n)?`${n.toFixed(1)}%`:'—';}
function fmtNum(n){return isFinite(n)?n.toFixed(1):'—';}
function fmtDate(d){return new Date(d).toLocaleString();}
function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
function slugify(s){return String(s).toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}

// =========================
// Dados de demonstração
// =========================
function makeDemoData(){
  const pick=a=>a[Math.floor(Math.random()*a.length)];
  const clusters=['RJ','ES','MG','SP'];
  const cidades={RJ:['RIO DE JANEIRO','NITEROI'],ES:['VILA VELHA'],MG:['BELO HORIZONTE'],SP:['SÃO PAULO','SANTOS']};
  const tipos=['MDU FILTRADO','SDU FILTRADO','NORMALIZADO SEM INTERVENÇÃO','CLEARDATE'];
  const out=[];
  for(let i=0;i<80;i++){
    const cl=pick(clusters);const ci=pick(cidades[cl]);
    const node=['CENACA','SPMOR','NIT-01','RIO-05'][Math.floor(Math.random()*4)]+'-'+(100+Math.floor(Math.random()*900));
    const dt=new Date(2025,9,10+Math.floor(Math.random()*7),6+Math.floor(Math.random()*18),Math.floor(Math.random()*60));
    const qpre=20+Math.random()*40;const qpos=qpre+(-10+Math.random()*40);
    out.push({Cluster:cl,Node:node,Cidade:ci,Data:dt,Tipo_Incidente:'INM'+String(10000000+Math.floor(Math.random()*99999)),Tipo_Fechamento:pick(tipos),QOE_Pre:Math.max(0,qpre),QOE_Pos:Math.max(0,qpos)});
  }
  return out;
}

</script>
</body>
</html>
