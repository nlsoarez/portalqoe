function analisarPlanilha() {
  let fileInput = document.getElementById('fileInput').files[0];
  if (!fileInput) {
    alert("Por favor, selecione um arquivo Excel.");
    return;
  }

  let reader = new FileReader();
  reader.onload = function(event) {
    let data = new Uint8Array(event.target.result);
    let workbook = XLSX.read(data, { type: 'array' });
    let sheet = workbook.Sheets[workbook.SheetNames[0]];
    let jsonData = XLSX.utils.sheet_to_json(sheet);

    let foraSLA30min = 0;
    let registrosForaSLA = [];

    jsonData.forEach(row => {
      const outage = String(row["Outage"] || "").trim();
      if (!outage || outage.startsWith("0")) return;

      const colF = Number(row["F"]);
      const colG = Number(row["G"]);
      if (!(colF === 1 && colG === 0)) return; // Apenas "Fora do SLA"

      let inicioRaw = row["Inicio"];
      let fimRaw = row["Fim"];
      let tempoMin = null;

      if (inicioRaw && fimRaw) {
        try {
          let inicio = !isNaN(inicioRaw) ? excelDateToJSDate(inicioRaw) : new Date(inicioRaw);
          let fim = !isNaN(fimRaw) ? excelDateToJSDate(fimRaw) : new Date(fimRaw);
          tempoMin = (fim - inicio) / (1000 * 60);
        } catch (e) {
          console.warn("Erro ao converter datas:", e);
        }
      }

      if (tempoMin !== null && tempoMin > 0 && tempoMin <= 30) {
        foraSLA30min++;
        registrosForaSLA.push({
          outageNum: outage,
          tempo: tempoMin.toFixed(2),
          inicio: inicioRaw,
          fim: fimRaw
        });
      }
    });

    // Atualiza os resultados na tela
    document.getElementById("casosGanho").innerText = "-";
    document.getElementById("casosPerdidos").innerText = "-";
    document.getElementById("casosPerdidos15").innerText = foraSLA30min;
    document.getElementById("percentagem15").innerText = "n/a";

    let outagesLista = document.getElementById("outagesLista");
    outagesLista.innerHTML = "";
    registrosForaSLA.forEach(({ outageNum, tempo, inicio, fim }) => {
      let div = document.createElement("div");
      div.className = "outage-card";
      div.innerHTML = `
        <div><strong>${outageNum}</strong></div>
        <div><span>Tempo: ${tempo} min</span></div>
        <div><span>In√≠cio: ${inicio}</span></div>
        <div><span>Fim: ${fim}</span></div>
      `;
      outagesLista.appendChild(div);
    });
  };
  reader.readAsArrayBuffer(fileInput);
}
