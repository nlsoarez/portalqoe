<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Análise de Outages</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .upload-area { border: 2px dashed #ccc; padding: 20px; text-align: center; }
  </style>
</head>
<body>
  <h1>Análise de Outages</h1>
  <div class="upload-area">
    <input type="file" id="fileUpload" multiple accept=".xlsx,.xls" />
    <p>Selecione uma ou mais planilhas Excel</p>
  </div>

  <div id="results"></div>

  <script>
    const nomesPorLogin = {
      "N0238475": "MARLEY MARQUES RIBEIRO",
      "N5923221": "KELLY PINHEIRO LIRA",
      "F160641": "JENNIFER MARIA ANDRADE SANTOS",
      "N5772086": "THIAGO PEREIRA DA SILVA",
      "N0239871": "LEONARDO FERREIRA LIMA DE ALMEIDA",
      "N5577565": "MARISTELLA MARCIA DOS SANTOS",
      "N5737414": "SANDRO DA SILVA CARVALHO",
      "N5972428": "CRISTIANE HERMOGENES DA SILVA",
      "N6173055": "JEFFERSON LUIS GONÇALVES COITINHO",
      "N5932090": "EVILÁZIO ANDRÉ DE MAGALHÃES GOMES PEREIRA",
      "N0255801": "ELBERTON ANICETO HENRIQUE",
      "N4014011": "ALAN MARINHO DIAS",
      "N5923996": "JULIO CESAR SANTOS SOARES",
    };

    document.getElementById('fileUpload').addEventListener('change', handleFiles, false);

    function handleFiles(e) {
      const files = e.target.files;
      let allData = [];

      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (evt) => {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          workbook.SheetNames.forEach((sheetName) => {
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
            allData = allData.concat(sheetData);
          });

          if (index === files.length - 1) {
            processData(allData);
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function processData(data) {
      const porLogin = {};
      const porCluster = {};
      const porHorario = {};
      const porTecnologia = {};

      data.forEach((row) => {
        const login = row["LOGIN"] || "Desconhecido";
        const cluster = row["CLUSTER"] || "Indefinido";
        const tecnologia = row["TECNOLOGIA"] || "Indefinido";
        let horario = "Indefinido";

        if (row["HORA"]) {
          horario = row["HORA"].toString().padStart(2, '0');
        } else if (row["INICIO"]) {
          const match = row["INICIO"].toString().match(/\b(\d{2}):/);
          if (match) horario = match[1];
        }

        // Volume por login
        if (!porLogin[login]) porLogin[login] = 0;
        porLogin[login]++;

        // Volume por cluster
        if (!porCluster[cluster]) porCluster[cluster] = 0;
        porCluster[cluster]++;

        // Volume por horário
        if (!porHorario[horario]) porHorario[horario] = 0;
        porHorario[horario]++;

        // Volume por tecnologia
        if (!porTecnologia[tecnologia]) porTecnologia[tecnologia] = 0;
        porTecnologia[tecnologia]++;
      });

      const totalOutages = data.length;

      const html = `
        <h2>Total de Outages: ${totalOutages}</h2>
        <h2>Volume por Login</h2>
        ${generateTable(porLogin, true)}
        <h2>Volume por Cluster</h2>
        ${generateTable(porCluster)}
        <h2>Volume por Horário</h2>
        ${generateTable(porHorario)}
        <h2>Volume por Tecnologia</h2>
        ${generateTable(porTecnologia)}
      `;

      document.getElementById("results").innerHTML = html;
    }

    function generateTable(data, traduzirLogin = false) {
      let rows = '<table><tr><th>Chave</th><th>Volume</th></tr>';
      Object.entries(data).forEach(([key, value]) => {
        const nome = traduzirLogin && nomesPorLogin[key] ? `${nomesPorLogin[key]} (${key})` : key;
        rows += `<tr><td>${nome}</td><td>${value}</td></tr>`;
      });
      return rows + '</table>';
    }
  </script>
</body>
</html>
